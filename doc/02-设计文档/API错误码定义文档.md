# API错误码定义文档

## 版本信息

| 版本号 | 编制日期 | 修订说明 | 编制人 |
| ---- | ----------- | ---- | ----- |
| V1.0 | 2025 年 11 月 | 初始版本 | 后端开发 |

## 1. 文档说明

### 1.1 文档目的

本文档定义文档转换工具API接口的统一错误码体系，包括错误码、错误消息、HTTP状态码映射、处理建议等，为API接口的错误处理提供统一标准。

### 1.2 适用范围

本文档适用于：

- API接口开发人员
- 前端开发人员
- SDK开发人员
- 第三方集成开发者

### 1.3 参考文档

- 《文档转换工具需求规格说明书（SRS）》
- 《RESTful API规范设计文档》
- 《错误处理机制详细设计文档（DDD）》

---

## 2. 错误码体系

### 2.1 错误码格式

```text
错误码格式：E[模块][序号]
- E：错误码前缀
- [模块]：2位数字，表示模块编号
- [序号]：3位数字，表示错误序号

示例：
- E00001：系统通用模块，错误序号001
- E01001：格式转换模块，错误序号001
- E08001：API接口模块，错误序号001
```

### 2.2 模块编号定义

| 模块编号 | 模块名称 | 说明 |
| ---- | ---- | ---- |
| 00 | 系统通用 | 系统级错误 |
| 01 | 格式转换 | 格式转换相关错误 |
| 02 | 文件上传 | 文件上传相关错误 |
| 03 | OCR识别 | OCR识别相关错误 |
| 04 | 批量处理 | 批量处理相关错误 |
| 05 | 缓存管理 | 缓存管理相关错误 |
| 06 | 用户管理 | 用户管理相关错误 |
| 07 | AI辅助 | AI辅助功能相关错误 |
| 08 | API接口 | API接口相关错误 |
| 09 | 数据库 | 数据库相关错误 |
| 10 | 文件存储 | 文件存储相关错误 |

### 2.3 错误级别

| 级别 | 代码 | 说明 | HTTP状态码映射 |
| ---- | ---- | ---- | ---- |
| 致命错误 | FATAL | 系统无法继续运行 | 500 |
| 严重错误 | ERROR | 功能无法正常完成 | 400/422/500 |
| 警告 | WARN | 功能可降级完成 | 200（带警告信息） |
| 信息 | INFO | 一般性信息 | 200 |

---

## 3. 错误码列表

### 3.1 系统通用错误（E00xxx）

| 错误码 | HTTP状态码 | 错误级别 | 错误消息 | 说明 | 处理建议 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| E00001 | 500 | FATAL | 系统内部错误 | 系统内部未知错误 | 联系技术支持 |
| E00002 | 400 | ERROR | 参数错误 | 请求参数不合法 | 检查请求参数格式和值 |
| E00003 | 401 | ERROR | 未认证 | Token无效或过期 | 重新获取Token |
| E00004 | 403 | ERROR | 权限不足 | 用户无权限执行操作 | 检查用户权限 |
| E00005 | 404 | ERROR | 资源不存在 | 请求的资源不存在 | 检查资源ID是否正确 |
| E00006 | 429 | ERROR | 请求频率超限 | 请求频率超过限制 | 降低请求频率，稍后重试 |
| E00007 | 503 | ERROR | 服务不可用 | 服务暂时不可用 | 稍后重试 |
| E00008 | 500 | ERROR | 网络错误 | 网络连接失败 | 检查网络连接 |
| E00009 | 408 | ERROR | 操作超时 | 操作执行超时 | 增加超时时间或稍后重试 |
| E00010 | 422 | ERROR | 请求格式错误 | 请求体格式不正确 | 检查请求体格式 |

### 3.2 格式转换错误（E01xxx）

| 错误码 | HTTP状态码 | 错误级别 | 错误消息 | 说明 | 处理建议 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| E01001 | 422 | ERROR | 格式不支持 | 源格式或目标格式不支持 | 检查支持的格式列表 |
| E01002 | 422 | ERROR | 文件损坏 | 源文件损坏或无法读取 | 重新上传文件 |
| E01003 | 500 | ERROR | 转换失败 | 转换过程失败 | 检查文件格式，稍后重试 |
| E01004 | 408 | ERROR | 转换超时 | 转换执行超时 | 使用异步模式或稍后重试 |
| E01005 | 200 | WARN | 格式保真度降低 | 转换后格式保真度降低 | 检查转换结果，必要时调整参数 |
| E01006 | 503 | ERROR | 引擎不可用 | 转换引擎不可用 | 稍后重试或联系技术支持 |
| E01007 | 500 | ERROR | 内存不足 | 转换过程内存不足 | 使用较小的文件或联系技术支持 |
| E01008 | 422 | ERROR | 转换路径不支持 | 不支持该转换路径 | 检查支持的转换路径 |
| E01009 | 422 | ERROR | 转换参数无效 | 转换参数配置错误 | 检查转换参数配置 |

### 3.3 文件上传错误（E02xxx）

| 错误码 | HTTP状态码 | 错误级别 | 错误消息 | 说明 | 处理建议 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| E02001 | 422 | ERROR | 文件格式不支持 | 文件格式不在支持列表中 | 检查支持的文件格式 |
| E02002 | 413 | ERROR | 文件过大 | 文件大小超过限制 | 使用较小的文件或升级账户 |
| E02003 | 422 | ERROR | 文件损坏 | 文件损坏或无法读取 | 重新上传文件 |
| E02004 | 500 | ERROR | 上传失败 | 文件上传失败 | 检查网络连接，重新上传 |
| E02005 | 507 | ERROR | 存储空间不足 | 存储空间不足 | 清理空间或升级账户 |
| E02006 | 200 | WARN | 文件名包含特殊字符 | 文件名包含特殊字符 | 文件名已自动处理 |
| E02007 | 422 | ERROR | 文件包含恶意内容 | 文件包含恶意内容 | 使用安全的文件 |
| E02008 | 422 | ERROR | 文件验证失败 | 文件验证失败 | 检查文件完整性 |
| E02009 | 409 | ERROR | 文件已存在 | 文件已存在 | 使用不同的文件名或删除旧文件 |

### 3.4 OCR识别错误（E03xxx）

| 错误码 | HTTP状态码 | 错误级别 | 错误消息 | 说明 | 处理建议 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| E03001 | 503 | ERROR | OCR引擎不可用 | OCR引擎不可用 | 稍后重试或联系技术支持 |
| E03002 | 422 | ERROR | 图像质量过低 | 图像质量过低无法识别 | 使用更高质量的图像 |
| E03003 | 500 | ERROR | 识别失败 | OCR识别失败 | 检查图像质量，稍后重试 |
| E03004 | 422 | ERROR | 语言不支持 | 不支持的语言 | 检查支持的语言列表 |
| E03005 | 200 | WARN | 识别准确度低 | 识别准确度低于预期 | 检查识别结果，必要时手动修正 |
| E03006 | 422 | ERROR | 图像格式不支持 | 图像格式不支持OCR | 转换为支持的图像格式 |
| E03007 | 422 | ERROR | 图像尺寸过大 | 图像尺寸超过限制 | 压缩图像或裁剪图像 |

### 3.5 批量处理错误（E04xxx）

| 错误码 | HTTP状态码 | 错误级别 | 错误消息 | 说明 | 处理建议 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| E04001 | 500 | ERROR | 批量任务创建失败 | 批量任务创建失败 | 检查文件列表，稍后重试 |
| E04002 | 503 | ERROR | 任务队列已满 | 任务队列已满 | 稍后重试或减少批量大小 |
| E04003 | 200 | WARN | 部分任务失败 | 批量任务中部分任务失败 | 查看失败任务详情，重试失败任务 |
| E04004 | 429 | ERROR | 并发数超限 | 并发处理数超过限制 | 减少并发数或升级账户 |
| E04005 | 422 | ERROR | 批量大小超限 | 批量文件数量超过限制 | 减少批量文件数量 |
| E04006 | 422 | ERROR | 批量总大小超限 | 批量文件总大小超过限制 | 减少批量文件或升级账户 |

### 3.6 缓存管理错误（E05xxx）

| 错误码 | HTTP状态码 | 错误级别 | 错误消息 | 说明 | 处理建议 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| E05001 | 200 | WARN | 缓存写入失败 | 缓存写入失败 | 系统将重新计算，不影响功能 |
| E05002 | 200 | WARN | 缓存读取失败 | 缓存读取失败 | 系统将重新计算，不影响功能 |
| E05003 | 200 | WARN | 临时文件清理失败 | 临时文件清理失败 | 系统将自动重试清理 |
| E05004 | 507 | ERROR | 存储空间不足 | 存储空间不足 | 清理空间或升级账户 |

### 3.7 用户管理错误（E06xxx）

| 错误码 | HTTP状态码 | 错误级别 | 错误消息 | 说明 | 处理建议 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| E06001 | 401 | ERROR | 登录失败 | 用户名或密码错误 | 检查用户名和密码 |
| E06002 | 401 | ERROR | Token过期 | Token已过期 | 重新获取Token |
| E06003 | 401 | ERROR | Token无效 | Token格式错误或无效 | 重新获取Token |
| E06004 | 403 | ERROR | 账户被禁用 | 用户账户已被禁用 | 联系管理员 |
| E06005 | 403 | ERROR | 权限不足 | 用户无权限执行操作 | 联系管理员提升权限 |
| E06006 | 409 | ERROR | 用户已存在 | 用户已存在 | 使用不同的用户名或登录 |
| E06007 | 422 | ERROR | 密码强度不足 | 密码不符合要求 | 使用更强的密码 |

### 3.8 AI辅助错误（E07xxx）

| 错误码 | HTTP状态码 | 错误级别 | 错误消息 | 说明 | 处理建议 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| E07001 | 503 | ERROR | AI服务不可用 | AI服务暂时不可用 | 稍后重试或使用非AI功能 |
| E07002 | 500 | ERROR | AI处理失败 | AI处理过程失败 | 稍后重试 |
| E07003 | 422 | ERROR | AI参数无效 | AI参数配置错误 | 检查AI参数配置 |
| E07004 | 429 | ERROR | AI配额不足 | AI服务配额已用完 | 升级账户或稍后使用 |
| E07005 | 200 | WARN | AI结果质量低 | AI处理结果质量低于预期 | 检查结果，必要时手动处理 |

### 3.9 API接口错误（E08xxx）

| 错误码 | HTTP状态码 | 错误级别 | 错误消息 | 说明 | 处理建议 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| E08001 | 400 | ERROR | 请求格式错误 | 请求体格式不正确 | 检查请求体格式 |
| E08002 | 400 | ERROR | 必需参数缺失 | 缺少必需的请求参数 | 检查必需参数 |
| E08003 | 400 | ERROR | 参数类型错误 | 参数类型不正确 | 检查参数类型 |
| E08004 | 400 | ERROR | 参数值无效 | 参数值不在有效范围内 | 检查参数值范围 |
| E08005 | 404 | ERROR | 接口不存在 | 请求的接口路径不存在 | 检查接口路径 |
| E08006 | 405 | ERROR | 方法不允许 | HTTP方法不允许 | 检查HTTP方法 |
| E08007 | 415 | ERROR | 媒体类型不支持 | Content-Type不支持 | 检查Content-Type |
| E08008 | 406 | ERROR | 接受类型不支持 | Accept类型不支持 | 检查Accept头 |
| E08009 | 400 | ERROR | API版本不支持 | API版本不存在或已废弃 | 使用支持的API版本 |
| E08010 | 429 | ERROR | 请求频率超限 | 请求频率超过限制 | 降低请求频率 |

### 3.10 数据库错误（E09xxx）

| 错误码 | HTTP状态码 | 错误级别 | 错误消息 | 说明 | 处理建议 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| E09001 | 500 | ERROR | 数据库连接失败 | 数据库连接失败 | 稍后重试或联系技术支持 |
| E09002 | 500 | ERROR | 数据库查询失败 | 数据库查询执行失败 | 稍后重试 |
| E09003 | 500 | ERROR | 数据库写入失败 | 数据库写入操作失败 | 稍后重试 |
| E09004 | 409 | ERROR | 数据冲突 | 数据冲突（如唯一约束） | 检查数据，使用不同的值 |

### 3.11 文件存储错误（E10xxx）

| 错误码 | HTTP状态码 | 错误级别 | 错误消息 | 说明 | 处理建议 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| E10001 | 500 | ERROR | 文件读取失败 | 文件读取操作失败 | 稍后重试 |
| E10002 | 500 | ERROR | 文件写入失败 | 文件写入操作失败 | 稍后重试 |
| E10003 | 500 | ERROR | 文件删除失败 | 文件删除操作失败 | 稍后重试 |
| E10004 | 507 | ERROR | 存储空间不足 | 存储空间不足 | 清理空间或升级账户 |
| E10005 | 404 | ERROR | 文件不存在 | 文件不存在或已删除 | 检查文件ID |

---

## 4. 错误响应格式

### 4.1 标准错误响应

所有API错误都返回统一的错误响应格式：

```typescript
interface ErrorResponse {
  success: false;
  error: {
    code: string;              // 错误码
    message: string;           // 错误消息（默认语言）
    messageI18n?: {            // 多语言消息（可选）
      zh_CN?: string;          // 简体中文
      zh_TW?: string;          // 繁体中文
      en?: string;             // 英文
      ja?: string;             // 日文
      ko?: string;             // 韩文
    };
    details?: any;             // 错误详情（可选）
    suggestion?: string;        // 处理建议（可选）
    retryable?: boolean;       // 是否可重试（可选）
    retryAfter?: number;       // 重试等待时间（秒，可选）
  };
  timestamp: string;           // 时间戳
  requestId?: string;          // 请求ID（可选）
}
```

### 4.2 错误响应示例

#### 4.2.1 参数错误

```json
{
  "success": false,
  "error": {
    "code": "E00002",
    "message": "参数错误",
    "messageI18n": {
      "zh_CN": "参数错误",
      "zh_TW": "參數錯誤",
      "en": "Parameter error",
      "ja": "パラメータエラー",
      "ko": "매개변수 오류"
    },
    "details": {
      "field": "targetFormat",
      "reason": "格式代码无效",
      "supportedFormats": ["pdf", "docx", "xlsx"]
    },
    "suggestion": "请使用支持的格式：pdf, docx, xlsx",
    "retryable": false
  },
  "timestamp": "2025-11-15T10:30:00Z",
  "requestId": "req_abc123"
}
```

#### 4.2.2 格式不支持

```json
{
  "success": false,
  "error": {
    "code": "E01001",
    "message": "格式不支持",
    "messageI18n": {
      "zh_CN": "格式不支持",
      "zh_TW": "格式不支援",
      "en": "Format not supported",
      "ja": "フォーマットがサポートされていません",
      "ko": "형식이 지원되지 않습니다"
    },
    "details": {
      "sourceFormat": "xyz",
      "targetFormat": "pdf",
      "supportedFormats": ["docx", "pdf", "xlsx"]
    },
    "suggestion": "请使用支持的格式：docx, pdf, xlsx",
    "retryable": false
  },
  "timestamp": "2025-11-15T10:30:00Z",
  "requestId": "req_abc123"
}
```

#### 4.2.3 请求频率超限

```json
{
  "success": false,
  "error": {
    "code": "E00006",
    "message": "请求频率超限",
    "messageI18n": {
      "zh_CN": "请求频率超限",
      "zh_TW": "請求頻率超限",
      "en": "Rate limit exceeded",
      "ja": "レート制限を超えました",
      "ko": "요청 빈도 제한 초과"
    },
    "details": {
      "limit": 1000,
      "remaining": 0,
      "resetAt": "2025-11-15T11:00:00Z"
    },
    "suggestion": "请降低请求频率，或在限制重置后重试",
    "retryable": true,
    "retryAfter": 1800
  },
  "timestamp": "2025-11-15T10:30:00Z",
  "requestId": "req_abc123"
}
```

---

## 5. HTTP状态码映射

### 5.1 状态码映射规则

| HTTP状态码 | 说明 | 适用错误类型 |
| ---- | ---- | ---- |
| 400 | Bad Request | 参数错误、请求格式错误 |
| 401 | Unauthorized | 认证失败、Token无效 |
| 403 | Forbidden | 权限不足、账户被禁用 |
| 404 | Not Found | 资源不存在、接口不存在 |
| 405 | Method Not Allowed | HTTP方法不允许 |
| 406 | Not Acceptable | 接受类型不支持 |
| 408 | Request Timeout | 操作超时 |
| 409 | Conflict | 资源冲突、数据冲突 |
| 413 | Payload Too Large | 文件过大 |
| 415 | Unsupported Media Type | 媒体类型不支持 |
| 422 | Unprocessable Entity | 业务逻辑错误（格式不支持、文件损坏等） |
| 429 | Too Many Requests | 请求频率超限 |
| 500 | Internal Server Error | 服务器内部错误 |
| 502 | Bad Gateway | 网关错误 |
| 503 | Service Unavailable | 服务不可用 |
| 504 | Gateway Timeout | 网关超时 |
| 507 | Insufficient Storage | 存储空间不足 |

### 5.2 状态码使用建议

- **400**：客户端请求错误，需要修改请求
- **401**：需要重新认证
- **403**：权限不足，需要提升权限
- **404**：资源不存在，检查资源ID
- **422**：请求格式正确但业务逻辑错误
- **429**：请求频率超限，需要降低频率
- **500**：服务器错误，稍后重试
- **503**：服务暂时不可用，稍后重试

---

## 6. 错误处理建议

### 6.1 客户端错误处理

#### 6.1.1 参数错误（400）

- 检查请求参数格式
- 验证必需参数是否存在
- 检查参数类型和值范围
- 参考API文档修正参数

#### 6.1.2 认证错误（401）

- 检查Token是否有效
- 检查Token是否过期
- 重新获取Token
- 检查API Key是否正确

#### 6.1.3 权限错误（403）

- 检查用户权限
- 联系管理员提升权限
- 检查资源所有权

#### 6.1.4 资源不存在（404）

- 检查资源ID是否正确
- 检查资源是否已删除
- 确认资源是否存在

#### 6.1.5 频率超限（429）

- 降低请求频率
- 使用指数退避策略
- 等待限制重置后重试
- 检查`retryAfter`字段

### 6.2 服务器错误处理

#### 6.2.1 服务器错误（500）

- 记录错误信息
- 稍后重试
- 联系技术支持

#### 6.2.2 服务不可用（503）

- 稍后重试
- 使用指数退避策略
- 检查服务状态

### 6.3 重试策略

#### 6.3.1 可重试错误

以下错误可以重试：

- **500**：服务器内部错误
- **502**：网关错误
- **503**：服务不可用
- **504**：网关超时
- **429**：请求频率超限（等待后重试）

#### 6.3.2 重试策略

- **指数退避**：重试间隔逐渐增加（1秒、2秒、4秒、8秒...）
- **最大重试次数**：最多重试3-5次
- **重试等待时间**：遵循`retryAfter`字段（如果有）

#### 6.3.3 不可重试错误

以下错误不应重试：

- **400**：参数错误（需要修改请求）
- **401**：认证错误（需要重新认证）
- **403**：权限错误（需要提升权限）
- **404**：资源不存在（资源确实不存在）
- **422**：业务逻辑错误（需要修改请求）

---

## 7. 多语言支持

### 7.1 支持的语言

- **zh_CN**：简体中文（默认）
- **zh_TW**：繁体中文
- **en**：英文
- **ja**：日文
- **ko**：韩文

### 7.2 语言选择

客户端通过`Accept-Language`请求头指定语言：

```http
Accept-Language: zh-CN,en-US;q=0.9
```

服务器根据请求头返回对应语言的错误消息。

### 7.3 默认语言

如果请求头未指定语言或语言不支持，返回默认语言（简体中文）的错误消息。

---

## 8. 错误码查询接口

### 8.1 查询所有错误码

**接口**：`GET /api/v1/errors`

**响应**：

```json
{
  "success": true,
  "data": [
    {
      "code": "E00001",
      "message": "系统内部错误",
      "httpStatus": 500,
      "level": "FATAL",
      "retryable": false
    },
    // ... 其他错误码
  ]
}
```

### 8.2 查询特定错误码

**接口**：`GET /api/v1/errors/{error_code}`

**响应**：

```json
{
  "success": true,
  "data": {
    "code": "E01001",
    "message": "格式不支持",
    "messageI18n": {
      "zh_CN": "格式不支持",
      "en": "Format not supported"
    },
    "httpStatus": 422,
    "level": "ERROR",
    "retryable": false,
    "suggestion": "请使用支持的格式"
  }
}
```

---

## 9. 使用示例

### 9.1 JavaScript/TypeScript

```typescript
// 错误处理函数
function handleError(error: ErrorResponse) {
  const errorCode = error.error.code;
  const errorMessage = error.error.message;
  const suggestion = error.error.suggestion;
  
  // 根据错误码处理
  switch (errorCode) {
    case 'E00003': // 未认证
      // 重新获取Token
      refreshToken();
      break;
    case 'E00006': // 请求频率超限
      // 等待后重试
      const retryAfter = error.error.retryAfter || 60;
      setTimeout(() => retryRequest(), retryAfter * 1000);
      break;
    case 'E01001': // 格式不支持
      // 显示错误消息和建议
      showError(errorMessage, suggestion);
      break;
    default:
      // 显示通用错误消息
      showError(errorMessage, suggestion);
  }
}
```

### 9.2 Python

```python
def handle_error(error_response):
    error_code = error_response['error']['code']
    error_message = error_response['error']['message']
    suggestion = error_response['error'].get('suggestion')
    
    # 根据错误码处理
    if error_code == 'E00003':  # 未认证
        refresh_token()
    elif error_code == 'E00006':  # 请求频率超限
        retry_after = error_response['error'].get('retryAfter', 60)
        time.sleep(retry_after)
        retry_request()
    elif error_code == 'E01001':  # 格式不支持
        show_error(error_message, suggestion)
    else:
        show_error(error_message, suggestion)
```

## 10. 附录

### 10.1 错误码快速参考

| 错误码范围 | 模块 | 常见错误 |
| ---- | ---- | ---- |
| E00xxx | 系统通用 | E00002（参数错误）、E00003（未认证）、E00006（频率超限） |
| E01xxx | 格式转换 | E01001（格式不支持）、E01002（文件损坏）、E01003（转换失败） |
| E02xxx | 文件上传 | E02001（格式不支持）、E02002（文件过大）、E02004（上传失败） |
| E03xxx | OCR识别 | E03001（引擎不可用）、E03002（图像质量过低） |
| E04xxx | 批量处理 | E04001（任务创建失败）、E04002（队列已满） |
| E08xxx | API接口 | E08001（请求格式错误）、E08002（参数缺失） |

### 10.2 参考资源

- 《RESTful API规范设计文档》
- 《错误处理机制详细设计文档（DDD）》

---

## 更新记录

| 版本号 | 更新日期 | 更新内容 | 更新人 |
| ---- | ---- | ---- | ---- |
| V1.0 | 2025 年 11 月 | 初始版本 | 后端开发 |
