# 开发规范文档

## 版本信息

| 版本号 | 编制日期 | 修订说明 | 编制人 |
| ---- | ----------- | ---- | ----- |
| V1.0 | 2025 年 11 月 | 初始版本 | 技术负责人 |

## 1. 文档说明

### 1.1 文档目的

本文档定义文档转换工具项目的开发规范，包括代码规范、命名规范、提交规范、文档规范等，确保项目代码质量和团队协作效率。

### 1.2 适用范围

本文档适用于：

- 所有开发人员
- 代码审查人员
- 项目管理人员

### 1.3 参考文档

- 《文档转换工具需求规格说明书（SRS）》
- 《技术选型方案文档》
- 《系统概要设计文档（HLD）》

---

## 2. 代码规范

### 2.1 编程语言规范

#### 2.1.1 TypeScript规范

- **版本**：TypeScript 5.0+
- **严格模式**：启用所有严格检查选项
- **代码风格**：遵循ESLint + Prettier配置

**tsconfig.json配置**：

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "lib": ["ES2022"],
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "moduleResolution": "node",
    "allowSyntheticDefaultImports": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

#### 2.1.2 JavaScript规范

- **版本**：ES2022+
- **代码风格**：遵循ESLint + Prettier配置
- **模块系统**：ES Modules

### 2.2 代码风格

#### 2.2.1 缩进和空格

- **缩进**：使用2个空格（不使用Tab）
- **行尾空格**：删除所有行尾空格
- **文件末尾**：保留一个空行

#### 2.2.2 行长度

- **最大行长度**：100个字符
- **超长处理**：合理换行，保持可读性

#### 2.2.3 引号

- **字符串**：使用单引号（`'`）
- **对象属性**：仅在必要时使用引号

#### 2.2.4 分号

- **规则**：不使用分号（使用ASI自动插入）

#### 2.2.5 大括号

- **规则**：始终使用大括号，即使只有一行代码

```typescript
// ✅ 正确
if (condition) {
  doSomething()
}

// ❌ 错误
if (condition) doSomething()
```

### 2.3 命名规范

#### 2.3.1 变量和函数

- **命名方式**：驼峰命名（camelCase）
- **命名规则**：使用有意义的名称，避免缩写

```typescript
// ✅ 正确
const userName = 'john'
const fileSize = 1024
function convertFile() {}

// ❌ 错误
const un = 'john'
const fs = 1024
function cv() {}
```

#### 2.3.2 常量

- **命名方式**：全大写下划线分隔（UPPER_SNAKE_CASE）
- **规则**：使用const声明

```typescript
// ✅ 正确
const MAX_FILE_SIZE = 100 * 1024 * 1024
const DEFAULT_TIMEOUT = 30000
const API_BASE_URL = 'https://api.example.com'

// ❌ 错误
const maxFileSize = 100 * 1024 * 1024
const defaultTimeout = 30000
```

#### 2.3.3 类和接口

- **命名方式**：帕斯卡命名（PascalCase）
- **规则**：类名使用名词，接口名使用名词或形容词

```typescript
// ✅ 正确
class FileConverter {}
interface ConversionOptions {}
type UserRole = 'admin' | 'user'

// ❌ 错误
class fileConverter {}
interface conversionOptions {}
```

#### 2.3.4 私有成员

- **命名方式**：以下划线（`_`）开头

```typescript
// ✅ 正确
class FileService {
  private _cache: Map<string, any>
  
  private _getCacheKey(fileId: string): string {
    return `file:${fileId}`
  }
}
```

#### 2.3.5 文件名

- **命名方式**：kebab-case（短横线分隔）
- **规则**：文件名应反映其内容

```typescript
// ✅ 正确
file-converter.ts
user-service.ts
conversion-options.interface.ts

// ❌ 错误
fileConverter.ts
UserService.ts
conversionOptions.interface.ts
```

### 2.4 类型定义

#### 2.4.1 类型注解

- **规则**：明确类型，避免使用`any`
- **优先使用**：接口（interface）而非类型别名（type alias）

```typescript
// ✅ 正确
interface User {
  id: string
  name: string
  email: string
}

function getUser(id: string): Promise<User> {
  // ...
}

// ❌ 错误
function getUser(id: any): Promise<any> {
  // ...
}
```

#### 2.4.2 可选属性

- **规则**：使用`?`标记可选属性

```typescript
// ✅ 正确
interface ConversionOptions {
  quality?: 'low' | 'medium' | 'high'
  ocrEnabled?: boolean
  timeout?: number
}
```

#### 2.4.3 联合类型

- **规则**：使用联合类型而非枚举（除非需要运行时值）

```typescript
// ✅ 正确
type TaskStatus = 'pending' | 'processing' | 'completed' | 'failed'

// ❌ 错误（除非需要运行时值）
enum TaskStatus {
  Pending = 'pending',
  Processing = 'processing',
  Completed = 'completed',
  Failed = 'failed'
}
```

### 2.5 函数规范

#### 2.5.1 函数长度

- **最大长度**：50行
- **超长处理**：拆分为多个小函数

#### 2.5.2 参数数量

- **最大参数**：5个
- **超多参数**：使用对象参数

```typescript
// ✅ 正确
function convertFile(options: ConversionOptions): Promise<File> {
  // ...
}

interface ConversionOptions {
  fileId: string
  targetFormat: string
  quality?: string
  ocrEnabled?: boolean
  timeout?: number
}

// ❌ 错误
function convertFile(
  fileId: string,
  targetFormat: string,
  quality: string,
  ocrEnabled: boolean,
  timeout: number,
  otherParam: string
): Promise<File> {
  // ...
}
```

#### 2.5.3 返回值

- **规则**：明确返回类型，避免隐式返回
- **异步函数**：使用`async/await`而非Promise链

```typescript
// ✅ 正确
async function getUser(id: string): Promise<User> {
  const user = await db.getUser(id)
  return user
}

// ❌ 错误
function getUser(id: string) {
  return db.getUser(id).then(user => user)
}
```

### 2.6 错误处理

#### 2.6.1 异常处理

- **规则**：使用try-catch处理异常
- **错误类型**：使用自定义错误类

```typescript
// ✅ 正确
class ConversionError extends Error {
  constructor(
    message: string,
    public code: string,
    public details?: any
  ) {
    super(message)
    this.name = 'ConversionError'
  }
}

async function convertFile(fileId: string): Promise<File> {
  try {
    return await conversionService.convert(fileId)
  } catch (error) {
    if (error instanceof ConversionError) {
      throw error
    }
    throw new ConversionError('转换失败', 'E01003', error)
  }
}
```

#### 2.6.2 空值处理

- **规则**：使用可选链（`?.`）和空值合并（`??`）

```typescript
// ✅ 正确
const userName = user?.name ?? 'Unknown'
const fileSize = file?.metadata?.size ?? 0

// ❌ 错误
const userName = user && user.name ? user.name : 'Unknown'
const fileSize = file && file.metadata && file.metadata.size ? file.metadata.size : 0
```

### 2.7 注释规范

#### 2.7.1 函数注释

- **规则**：使用JSDoc格式注释
- **必需内容**：函数说明、参数说明、返回值说明

```typescript
/**
 * 转换文件格式
 * @param fileId 文件ID
 * @param targetFormat 目标格式
 * @param options 转换选项
 * @returns 转换后的文件
 * @throws {ConversionError} 转换失败时抛出
 */
async function convertFile(
  fileId: string,
  targetFormat: string,
  options?: ConversionOptions
): Promise<File> {
  // ...
}
```

#### 2.7.2 类注释

- **规则**：使用JSDoc格式注释类

```typescript
/**
 * 文件转换服务
 * 提供文件格式转换功能
 */
class FileConverterService {
  // ...
}
```

#### 2.7.3 代码注释

- **规则**：解释"为什么"而非"是什么"
- **避免**：显而易见的注释

```typescript
// ✅ 正确
// 使用缓存避免重复转换相同文件
const cachedResult = await cache.get(fileId)

// ❌ 错误
// 获取缓存结果
const cachedResult = await cache.get(fileId)
```

---

## 3. 项目结构规范

### 3.1 目录结构

```text
project/
├── src/                    # 源代码目录
│   ├── api/               # API接口
│   ├── services/          # 业务服务
│   ├── models/            # 数据模型
│   ├── utils/             # 工具函数
│   ├── config/            # 配置文件
│   ├── middleware/        # 中间件
│   └── types/             # 类型定义
├── tests/                 # 测试代码
│   ├── unit/              # 单元测试
│   ├── integration/       # 集成测试
│   └── e2e/               # 端到端测试
├── docs/                  # 文档
├── scripts/               # 脚本文件
├── .github/               # GitHub配置
├── .vscode/               # VS Code配置
├── package.json
├── tsconfig.json
├── .eslintrc.js
├── .prettierrc
└── README.md
```

### 3.2 文件组织

#### 3.2.1 模块组织

- **规则**：按功能模块组织文件
- **结构**：每个模块包含相关文件

```text
src/
├── conversion/
│   ├── conversion.service.ts
│   ├── conversion.controller.ts
│   ├── conversion.interface.ts
│   └── conversion.types.ts
├── file/
│   ├── file.service.ts
│   ├── file.controller.ts
│   └── file.interface.ts
```

#### 3.2.2 导入顺序

- **规则**：按以下顺序导入
  1. 外部库（node_modules）
  2. 内部模块（@/别名）
  3. 相对路径导入
  4. 类型导入（使用`import type`）

```typescript
// ✅ 正确
import { FastifyInstance } from 'fastify'
import { Request, Response } from 'express'
import type { User } from '@/types/user'
import { FileService } from '@/services/file.service'
import { logger } from '../utils/logger'
import type { ConversionOptions } from './conversion.interface'
```

---

## 4. Git提交规范

### 4.1 提交消息格式

使用Conventional Commits规范：

```text
<type>(<scope>): <subject>

<body>

<footer>
```

#### 4.1.1 类型（type）

- **feat**：新功能
- **fix**：修复bug
- **docs**：文档更新
- **style**：代码格式调整（不影响功能）
- **refactor**：代码重构
- **perf**：性能优化
- **test**：测试相关
- **chore**：构建/工具相关
- **ci**：CI/CD相关

#### 4.1.2 范围（scope）

- **api**：API相关
- **service**：服务相关
- **model**：数据模型相关
- **ui**：UI相关
- **config**：配置相关
- **doc**：文档相关

#### 4.1.3 主题（subject）

- **规则**：使用祈使句，首字母小写，不加句号
- **长度**：不超过50个字符

#### 4.1.4 正文（body）

- **规则**：详细说明变更原因和方式
- **长度**：每行不超过72个字符

#### 4.1.5 页脚（footer）

- **规则**：说明破坏性变更或关闭的issue

### 4.2 提交示例

```bash
# 新功能
feat(conversion): 添加批量转换功能

实现批量文件转换功能，支持最多100个文件同时转换。
添加批量任务队列管理和进度监控。

Closes #123

# 修复bug
fix(file): 修复文件上传大小限制问题

修复文件上传时大小限制检查逻辑错误，确保正确验证文件大小。

Fixes #456

# 文档更新
docs(api): 更新API接口文档

更新单文件转换接口文档，添加新的转换选项说明。

# 代码重构
refactor(service): 重构文件服务代码

将文件服务拆分为多个小模块，提高代码可维护性。
```

### 4.3 分支规范

#### 4.3.1 分支命名

- **主分支**：`main`（生产环境）
- **开发分支**：`develop`（开发环境）
- **功能分支**：`feature/<功能名>`
- **修复分支**：`fix/<问题描述>`
- **发布分支**：`release/<版本号>`
- **热修复分支**：`hotfix/<问题描述>`

#### 4.3.2 分支策略

```text
main (生产环境)
  ↑
release/v1.0.0 (发布分支)
  ↑
develop (开发环境)
  ↑
feature/user-management (功能分支)
  ↑
fix/file-upload-bug (修复分支)
```

---

## 5. 代码审查规范

### 5.1 审查检查项

#### 5.1.1 功能检查

- [ ] 代码实现符合需求
- [ ] 边界条件处理正确
- [ ] 错误处理完善
- [ ] 性能考虑合理

#### 5.1.2 代码质量

- [ ] 代码风格符合规范
- [ ] 命名清晰有意义
- [ ] 函数长度合理
- [ ] 注释充分且准确

#### 5.1.3 测试检查

- [ ] 单元测试覆盖充分
- [ ] 测试用例通过
- [ ] 边界情况有测试

#### 5.1.4 安全检查

- [ ] 无安全漏洞
- [ ] 敏感信息未泄露
- [ ] 输入验证充分

### 5.2 审查流程

1. **提交PR**：创建Pull Request
2. **自动检查**：CI/CD自动运行检查
3. **代码审查**：至少1人审查通过
4. **合并代码**：审查通过后合并

---

## 6. 测试规范

### 6.1 测试类型

- **单元测试**：测试单个函数或类
- **集成测试**：测试模块间交互
- **端到端测试**：测试完整流程

### 6.2 测试覆盖率

- **目标**：单元测试覆盖率≥80%
- **关键代码**：覆盖率≥90%

### 6.3 测试命名

- **规则**：使用描述性名称
- **格式**：`describe('模块名', () => { it('应该...', () => {}) })`

```typescript
// ✅ 正确
describe('FileConverterService', () => {
  describe('convertFile', () => {
    it('应该成功转换文件格式', async () => {
      // ...
    })
    
    it('应该在文件不存在时抛出错误', async () => {
      // ...
    })
  })
})
```

---

## 7. 文档规范

### 7.1 代码文档

- **规则**：使用JSDoc格式
- **必需**：公共API必须有文档

### 7.2 README文档

每个模块应包含README.md，说明：

- 模块功能
- 使用方法
- 配置说明
- 示例代码

### 7.3 API文档

- **格式**：OpenAPI 3.0
- **工具**：Swagger UI
- **更新**：代码变更时同步更新

---

## 8. 性能规范

### 8.1 代码性能

- **规则**：避免不必要的计算
- **优化**：合理使用缓存
- **监控**：关键路径添加性能监控

### 8.2 资源使用

- **内存**：避免内存泄漏
- **CPU**：避免CPU密集型操作阻塞
- **网络**：合理使用连接池

---

## 9. 安全规范

### 9.1 输入验证

- **规则**：所有输入必须验证
- **检查**：类型、范围、格式

### 9.2 敏感信息

- **规则**：不在代码中硬编码敏感信息
- **存储**：使用环境变量或密钥管理服务

### 9.3 依赖安全

- **规则**：定期更新依赖
- **检查**：使用安全扫描工具

---

## 10. 工具配置

### 10.1 ESLint配置

```json
{
  "extends": [
    "eslint:recommended",
    "@typescript-eslint/recommended",
    "prettier"
  ],
  "rules": {
    "@typescript-eslint/no-explicit-any": "error",
    "@typescript-eslint/explicit-function-return-type": "warn",
    "@typescript-eslint/no-unused-vars": "error"
  }
}
```

### 10.2 Prettier配置

```json
{
  "semi": false,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "arrowParens": "avoid"
}
```

### 10.3 EditorConfig配置

```ini
root = true

[*]
charset = utf-8
end_of_line = lf
indent_style = space
indent_size = 2
insert_final_newline = true
trim_trailing_whitespace = true

[*.md]
trim_trailing_whitespace = false
```

---

## 11. 附录

### 11.1 参考资源

- [TypeScript官方文档](https://www.typescriptlang.org/docs/)
- [ESLint规则](https://eslint.org/docs/rules/)
- [Prettier配置](https://prettier.io/docs/en/configuration.html)
- [Conventional Commits](https://www.conventionalcommits.org/)

### 11.2 工具推荐

- **IDE**：VS Code
- **代码格式化**：Prettier
- **代码检查**：ESLint
- **Git工具**：GitKraken / SourceTree
- **API测试**：Postman / Insomnia

---

## 更新记录

| 版本号 | 更新日期 | 更新内容 | 更新人 |
| ---- | ---- | ---- | ---- |
| V1.0 | 2025 年 11 月 | 初始版本 | 技术负责人 |
