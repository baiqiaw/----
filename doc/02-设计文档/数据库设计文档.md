# 数据库设计文档

## 版本信息

| 版本号 | 编制日期 | 修订说明 | 编制人 |
| ---- | ----------- | ---- | ----- |
| V1.0 | 2025 年 11 月 | 初始版本 | 数据库设计 |

## 1. 文档说明

### 1.1 文档目的

本文档详细设计文档转换工具系统的数据库结构，包括数据模型设计、ER图、索引设计、迁移脚本等，为数据库实现提供详细指导。

### 1.2 适用范围

本文档适用于：

- 数据库设计人员
- 后端开发人员
- 系统架构师

### 1.3 参考文档

- 《文档转换工具需求规格说明书（SRS）》
- 《系统概要设计文档（HLD）》
- 《认证授权机制设计文档》
- 《批量处理模块详细设计文档（DDD）》

---

## 2. 数据库概述

### 2.1 数据库选型

- **数据库类型**：PostgreSQL 14+
- **字符集**：UTF-8
- **时区**：UTC

### 2.2 设计原则

- **规范化**：遵循第三范式（3NF）
- **性能优化**：合理使用索引和分区
- **可扩展性**：支持水平扩展
- **数据安全**：敏感数据加密存储

### 2.3 命名规范

- **表名**：小写字母，使用下划线分隔，复数形式（如：`users`, `conversion_tasks`）
- **字段名**：小写字母，使用下划线分隔（如：`user_id`, `created_at`）
- **索引名**：`idx_{table}_{field}`（如：`idx_users_email`）
- **外键名**：`fk_{table}_{referenced_table}`（如：`fk_tasks_user_id`）

---

## 3. 枚举类型和字典表设计

### 3.1 枚举类型定义

PostgreSQL枚举类型用于固定且不经常变化的枚举值：

```sql
-- 用户角色枚举
CREATE TYPE user_role_enum AS ENUM (
    'admin',              -- 系统管理员
    'enterprise_admin',   -- 企业管理员
    'enterprise_user',    -- 企业用户
    'basic_user',         -- 基础用户
    'free_user'           -- 免费用户
);

-- 账户类型枚举
CREATE TYPE account_type_enum AS ENUM (
    'free',       -- 免费账户
    'basic',      -- 基础账户
    'enterprise'  -- 企业账户
);

-- 用户状态枚举
CREATE TYPE user_status_enum AS ENUM (
    'active',     -- 激活
    'disabled',   -- 禁用
    'suspended'  -- 暂停
);

-- 存储类型枚举
CREATE TYPE storage_type_enum AS ENUM (
    'local',  -- 本地存储
    's3',     -- AWS S3
    'oss'     -- 阿里云OSS
);

-- 文件状态枚举
CREATE TYPE file_status_enum AS ENUM (
    'active',   -- 活跃
    'deleted', -- 已删除
    'expired'  -- 已过期
);

-- 任务类型枚举
CREATE TYPE task_type_enum AS ENUM (
    'single',  -- 单文件转换
    'batch'    -- 批量转换
);

-- 任务状态枚举
CREATE TYPE task_status_enum AS ENUM (
    'pending',     -- 待处理
    'processing',  -- 处理中
    'completed',   -- 已完成
    'failed',      -- 失败
    'cancelled'    -- 已取消
);

-- 批量任务状态枚举
CREATE TYPE batch_task_status_enum AS ENUM (
    'pending',     -- 待处理
    'processing',  -- 处理中
    'completed',   -- 已完成
    'failed',      -- 失败
    'cancelled',   -- 已取消
    'paused',      -- 已暂停
    'partial'      -- 部分完成
);

-- Token类型枚举
CREATE TYPE token_type_enum AS ENUM (
    'access',   -- 访问令牌
    'refresh'   -- 刷新令牌
);

-- 配置类型枚举
CREATE TYPE config_type_enum AS ENUM (
    'string',   -- 字符串
    'number',   -- 数字
    'boolean',  -- 布尔值
    'json'      -- JSON对象
);
```

### 3.2 字典表设计

字典表用于存储可扩展的枚举值，支持动态添加和管理：

#### 3.2.1 文件格式字典表（file_formats）

```sql
CREATE TABLE file_formats (
    format_code VARCHAR(50) PRIMARY KEY,
    format_name VARCHAR(100) NOT NULL,
    format_category VARCHAR(50) NOT NULL, -- document/image/spreadsheet/presentation
    mime_type VARCHAR(100),
    file_extension VARCHAR(20) NOT NULL,
    is_supported BOOLEAN NOT NULL DEFAULT true,
    is_input BOOLEAN NOT NULL DEFAULT true,  -- 是否支持作为输入格式
    is_output BOOLEAN NOT NULL DEFAULT true, -- 是否支持作为输出格式
    description TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE file_formats IS '文件格式字典表';
COMMENT ON COLUMN file_formats.format_code IS '格式代码（如：docx/pdf/xlsx）';
COMMENT ON COLUMN file_formats.format_name IS '格式名称（如：Microsoft Word Document）';
COMMENT ON COLUMN file_formats.format_category IS '格式分类（document/image/spreadsheet/presentation）';
COMMENT ON COLUMN file_formats.mime_type IS 'MIME类型';
COMMENT ON COLUMN file_formats.file_extension IS '文件扩展名';
COMMENT ON COLUMN file_formats.is_supported IS '是否支持';
COMMENT ON COLUMN file_formats.is_input IS '是否支持作为输入格式';
COMMENT ON COLUMN file_formats.is_output IS '是否支持作为输出格式';
```

#### 3.2.2 审计操作类型字典表（audit_actions）

```sql
CREATE TABLE audit_actions (
    action_code VARCHAR(100) PRIMARY KEY,
    action_name VARCHAR(200) NOT NULL,
    action_category VARCHAR(50) NOT NULL, -- login/file/task/user/system
    description TEXT,
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE audit_actions IS '审计操作类型字典表';
COMMENT ON COLUMN audit_actions.action_code IS '操作代码（如：user.login/file.upload/task.create）';
COMMENT ON COLUMN audit_actions.action_name IS '操作名称（如：用户登录/文件上传/任务创建）';
COMMENT ON COLUMN audit_actions.action_category IS '操作分类（login/file/task/user/system）';
```

#### 3.2.3 资源类型字典表（resource_types）

```sql
CREATE TABLE resource_types (
    resource_code VARCHAR(50) PRIMARY KEY,
    resource_name VARCHAR(100) NOT NULL,
    description TEXT,
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE resource_types IS '资源类型字典表';
COMMENT ON COLUMN resource_types.resource_code IS '资源代码（如：user/file/task/batch）';
COMMENT ON COLUMN resource_types.resource_name IS '资源名称（如：用户/文件/任务/批量任务）';
```

### 3.3 字典表初始化数据

```sql
-- 文件格式字典表初始化数据
INSERT INTO file_formats (format_code, format_name, format_category, mime_type, file_extension, is_input, is_output, description) VALUES
-- 文档格式
('docx', 'Microsoft Word Document', 'document', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', '.docx', true, true, 'Word 2007+文档'),
('doc', 'Microsoft Word Document (Legacy)', 'document', 'application/msword', '.doc', true, false, 'Word 97-2003文档'),
('pdf', 'Portable Document Format', 'document', 'application/pdf', '.pdf', true, true, 'PDF文档'),
('txt', 'Plain Text', 'document', 'text/plain', '.txt', true, true, '纯文本文件'),
('md', 'Markdown', 'document', 'text/markdown', '.md', true, true, 'Markdown文档'),
('rtf', 'Rich Text Format', 'document', 'application/rtf', '.rtf', true, true, 'RTF文档'),
('html', 'HyperText Markup Language', 'document', 'text/html', '.html', true, true, 'HTML文档'),
('odt', 'OpenDocument Text', 'document', 'application/vnd.oasis.opendocument.text', '.odt', true, true, 'OpenDocument文本'),
-- 电子表格格式
('xlsx', 'Microsoft Excel Spreadsheet', 'spreadsheet', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', '.xlsx', true, true, 'Excel 2007+电子表格'),
('xls', 'Microsoft Excel Spreadsheet (Legacy)', 'spreadsheet', 'application/vnd.ms-excel', '.xls', true, false, 'Excel 97-2003电子表格'),
('csv', 'Comma-Separated Values', 'spreadsheet', 'text/csv', '.csv', true, true, 'CSV文件'),
('ods', 'OpenDocument Spreadsheet', 'spreadsheet', 'application/vnd.oasis.opendocument.spreadsheet', '.ods', true, true, 'OpenDocument电子表格'),
-- 演示文稿格式
('pptx', 'Microsoft PowerPoint Presentation', 'presentation', 'application/vnd.openxmlformats-officedocument.presentationml.presentation', '.pptx', true, true, 'PowerPoint 2007+演示文稿'),
('ppt', 'Microsoft PowerPoint Presentation (Legacy)', 'presentation', 'application/vnd.ms-powerpoint', '.ppt', true, false, 'PowerPoint 97-2003演示文稿'),
('odp', 'OpenDocument Presentation', 'presentation', 'application/vnd.oasis.opendocument.presentation', '.odp', true, true, 'OpenDocument演示文稿'),
-- 图像格式
('jpg', 'JPEG Image', 'image', 'image/jpeg', '.jpg', true, true, 'JPEG图像'),
('jpeg', 'JPEG Image', 'image', 'image/jpeg', '.jpeg', true, true, 'JPEG图像'),
('png', 'PNG Image', 'image', 'image/png', '.png', true, true, 'PNG图像'),
('gif', 'GIF Image', 'image', 'image/gif', '.gif', true, true, 'GIF图像'),
('bmp', 'Bitmap Image', 'image', 'image/bmp', '.bmp', true, true, 'BMP图像'),
('tiff', 'TIFF Image', 'image', 'image/tiff', '.tiff', true, true, 'TIFF图像'),
('webp', 'WebP Image', 'image', 'image/webp', '.webp', true, true, 'WebP图像');

-- 审计操作类型字典表初始化数据
INSERT INTO audit_actions (action_code, action_name, action_category, description) VALUES
-- 登录相关
('user.login', '用户登录', 'login', '用户登录系统'),
('user.logout', '用户登出', 'login', '用户登出系统'),
('user.login_failed', '登录失败', 'login', '用户登录失败'),
-- 文件相关
('file.upload', '文件上传', 'file', '用户上传文件'),
('file.download', '文件下载', 'file', '用户下载文件'),
('file.delete', '文件删除', 'file', '用户删除文件'),
('file.view', '文件查看', 'file', '用户查看文件'),
-- 任务相关
('task.create', '任务创建', 'task', '创建转换任务'),
('task.cancel', '任务取消', 'task', '取消转换任务'),
('task.query', '任务查询', 'task', '查询任务状态'),
('batch.create', '批量任务创建', 'task', '创建批量转换任务'),
('batch.cancel', '批量任务取消', 'task', '取消批量转换任务'),
-- 用户相关
('user.create', '用户创建', 'user', '创建新用户'),
('user.update', '用户更新', 'user', '更新用户信息'),
('user.delete', '用户删除', 'user', '删除用户'),
('user.password_change', '密码修改', 'user', '用户修改密码'),
('api_key.create', 'API密钥创建', 'user', '创建API密钥'),
('api_key.delete', 'API密钥删除', 'user', '删除API密钥'),
-- 系统相关
('system.config_update', '系统配置更新', 'system', '更新系统配置'),
('system.maintenance', '系统维护', 'system', '系统维护操作');

-- 资源类型字典表初始化数据
INSERT INTO resource_types (resource_code, resource_name, description) VALUES
('user', '用户', '用户资源'),
('file', '文件', '文件资源'),
('task', '任务', '转换任务资源'),
('batch', '批量任务', '批量转换任务资源'),
('api_key', 'API密钥', 'API密钥资源'),
('config', '配置', '系统配置资源');
```

---

## 4. 数据模型设计

### 4.1 用户相关表

#### 4.1.1 用户表（users）

```sql
CREATE TABLE users (
    user_id VARCHAR(64) PRIMARY KEY,
    username VARCHAR(100) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    salt VARCHAR(64) NOT NULL,
    role user_role_enum NOT NULL DEFAULT 'free_user',
    account_type account_type_enum NOT NULL DEFAULT 'free',
    status user_status_enum NOT NULL DEFAULT 'active',
    last_login_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);

COMMENT ON TABLE users IS '用户表';
COMMENT ON COLUMN users.user_id IS '用户ID';
COMMENT ON COLUMN users.username IS '用户名';
COMMENT ON COLUMN users.email IS '邮箱';
COMMENT ON COLUMN users.password_hash IS '密码哈希值';
COMMENT ON COLUMN users.salt IS '密码盐值';
COMMENT ON COLUMN users.role IS '用户角色（使用user_role_enum枚举类型）';
COMMENT ON COLUMN users.account_type IS '账户类型（使用account_type_enum枚举类型）';
COMMENT ON COLUMN users.status IS '账户状态（使用user_status_enum枚举类型）';
COMMENT ON COLUMN users.last_login_at IS '最后登录时间';
```

#### 4.1.2 用户配置表（user_settings）

```sql
CREATE TABLE user_settings (
    setting_id VARCHAR(64) PRIMARY KEY,
    user_id VARCHAR(64) NOT NULL,
    setting_key VARCHAR(100) NOT NULL,
    setting_value TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, setting_key),
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

COMMENT ON TABLE user_settings IS '用户配置表';
COMMENT ON COLUMN user_settings.setting_id IS '配置ID';
COMMENT ON COLUMN user_settings.user_id IS '用户ID';
COMMENT ON COLUMN user_settings.setting_key IS '配置键';
COMMENT ON COLUMN user_settings.setting_value IS '配置值（JSON格式）';
```

#### 4.1.3 API密钥表（api_keys）

```sql
CREATE TABLE api_keys (
    key_id VARCHAR(64) PRIMARY KEY,
    user_id VARCHAR(64) NOT NULL,
    key_name VARCHAR(100) NOT NULL,
    hashed_key VARCHAR(255) NOT NULL UNIQUE,
    permissions TEXT[], -- 权限列表
    expires_at TIMESTAMP,
    last_used_at TIMESTAMP,
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

COMMENT ON TABLE api_keys IS 'API密钥表';
COMMENT ON COLUMN api_keys.key_id IS '密钥ID';
COMMENT ON COLUMN api_keys.user_id IS '用户ID';
COMMENT ON COLUMN api_keys.key_name IS '密钥名称';
COMMENT ON COLUMN api_keys.hashed_key IS '密钥哈希值';
COMMENT ON COLUMN api_keys.permissions IS '权限列表';
COMMENT ON COLUMN api_keys.expires_at IS '过期时间';
COMMENT ON COLUMN api_keys.last_used_at IS '最后使用时间';
```

### 4.2 文件相关表

#### 4.2.1 文件表（files）

```sql
CREATE TABLE files (
    file_id VARCHAR(64) PRIMARY KEY,
    user_id VARCHAR(64),
    file_name VARCHAR(255) NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(100),
    file_format VARCHAR(50),
    file_hash VARCHAR(64), -- SHA-256哈希值
    storage_type storage_type_enum NOT NULL DEFAULT 'local',
    storage_path VARCHAR(500),
    metadata JSONB, -- 文件元数据（页数、字数等）
    auto_delete BOOLEAN NOT NULL DEFAULT false,
    delete_after_hours INTEGER,
    tags TEXT[],
    status file_status_enum NOT NULL DEFAULT 'active',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (file_format) REFERENCES file_formats(format_code) ON DELETE SET NULL
);

COMMENT ON TABLE files IS '文件表';
COMMENT ON COLUMN files.file_id IS '文件ID';
COMMENT ON COLUMN files.user_id IS '用户ID（可为空，支持匿名上传）';
COMMENT ON COLUMN files.file_name IS '存储文件名';
COMMENT ON COLUMN files.original_name IS '原始文件名';
COMMENT ON COLUMN files.file_path IS '文件存储路径';
COMMENT ON COLUMN files.file_size IS '文件大小（字节）';
COMMENT ON COLUMN files.mime_type IS 'MIME类型';
COMMENT ON COLUMN files.file_format IS '文件格式（引用file_formats字典表）';
COMMENT ON COLUMN files.file_hash IS '文件哈希值（用于去重）';
COMMENT ON COLUMN files.storage_type IS '存储类型（使用storage_type_enum枚举类型）';
COMMENT ON COLUMN files.metadata IS '文件元数据（JSON格式）';
COMMENT ON COLUMN files.auto_delete IS '是否自动删除';
COMMENT ON COLUMN files.delete_after_hours IS '自动删除时间（小时）';
COMMENT ON COLUMN files.status IS '文件状态（使用file_status_enum枚举类型）';
```

### 4.3 转换任务相关表

#### 4.3.1 转换任务表（conversion_tasks）

```sql
CREATE TABLE conversion_tasks (
    task_id VARCHAR(64) PRIMARY KEY,
    user_id VARCHAR(64),
    task_type task_type_enum NOT NULL,
    batch_id VARCHAR(64), -- 批量任务ID（批量任务时使用）
    source_file_id VARCHAR(64) NOT NULL,
    target_format VARCHAR(50) NOT NULL,
    source_format VARCHAR(50),
    status task_status_enum NOT NULL DEFAULT 'pending',
    progress INTEGER NOT NULL DEFAULT 0, -- 0-100
    options JSONB, -- 转换选项
    result_file_id VARCHAR(64),
    error_code VARCHAR(20),
    error_message TEXT,
    conversion_time INTEGER, -- 转换耗时（毫秒）
    quality_metrics JSONB, -- 质量指标（保真度、准确度等）
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (source_file_id) REFERENCES files(file_id) ON DELETE CASCADE,
    FOREIGN KEY (result_file_id) REFERENCES files(file_id) ON DELETE SET NULL,
    FOREIGN KEY (target_format) REFERENCES file_formats(format_code) ON DELETE RESTRICT,
    FOREIGN KEY (source_format) REFERENCES file_formats(format_code) ON DELETE SET NULL,
    FOREIGN KEY (batch_id) REFERENCES batch_tasks(batch_id) ON DELETE CASCADE
);

COMMENT ON TABLE conversion_tasks IS '转换任务表';
COMMENT ON COLUMN conversion_tasks.task_id IS '任务ID';
COMMENT ON COLUMN conversion_tasks.user_id IS '用户ID';
COMMENT ON COLUMN conversion_tasks.task_type IS '任务类型（使用task_type_enum枚举类型）';
COMMENT ON COLUMN conversion_tasks.batch_id IS '批量任务ID';
COMMENT ON COLUMN conversion_tasks.source_file_id IS '源文件ID';
COMMENT ON COLUMN conversion_tasks.target_format IS '目标格式（引用file_formats字典表）';
COMMENT ON COLUMN conversion_tasks.source_format IS '源格式（引用file_formats字典表）';
COMMENT ON COLUMN conversion_tasks.status IS '任务状态（使用task_status_enum枚举类型）';
COMMENT ON COLUMN conversion_tasks.progress IS '任务进度（0-100）';
COMMENT ON COLUMN conversion_tasks.options IS '转换选项（JSON格式）';
COMMENT ON COLUMN conversion_tasks.result_file_id IS '结果文件ID';
COMMENT ON COLUMN conversion_tasks.error_code IS '错误码';
COMMENT ON COLUMN conversion_tasks.error_message IS '错误消息';
COMMENT ON COLUMN conversion_tasks.conversion_time IS '转换耗时（毫秒）';
COMMENT ON COLUMN conversion_tasks.quality_metrics IS '质量指标（JSON格式）';
```

#### 4.3.2 批量任务表（batch_tasks）

```sql
CREATE TABLE batch_tasks (
    batch_id VARCHAR(64) PRIMARY KEY,
    user_id VARCHAR(64) NOT NULL,
    batch_name VARCHAR(255),
    total_files INTEGER NOT NULL,
    target_format VARCHAR(50) NOT NULL,
    status batch_task_status_enum NOT NULL DEFAULT 'pending',
    progress JSONB, -- 进度信息（total/completed/failed/percentage）
    batch_options JSONB, -- 批量处理选项（合并、命名规则等）
    merged_file_id VARCHAR(64), -- 合并文件ID（如果启用合并）
    summary JSONB, -- 汇总信息（成功数、失败数、成功率等）
    error_code VARCHAR(20),
    error_message TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (merged_file_id) REFERENCES files(file_id) ON DELETE SET NULL,
    FOREIGN KEY (target_format) REFERENCES file_formats(format_code) ON DELETE RESTRICT
);

COMMENT ON TABLE batch_tasks IS '批量任务表';
COMMENT ON COLUMN batch_tasks.batch_id IS '批量任务ID';
COMMENT ON COLUMN batch_tasks.user_id IS '用户ID';
COMMENT ON COLUMN batch_tasks.batch_name IS '批量任务名称';
COMMENT ON COLUMN batch_tasks.total_files IS '总文件数';
COMMENT ON COLUMN batch_tasks.target_format IS '目标格式（引用file_formats字典表）';
COMMENT ON COLUMN batch_tasks.status IS '任务状态（使用batch_task_status_enum枚举类型）';
COMMENT ON COLUMN batch_tasks.progress IS '进度信息（JSON格式）';
COMMENT ON COLUMN batch_tasks.batch_options IS '批量处理选项（JSON格式）';
COMMENT ON COLUMN batch_tasks.merged_file_id IS '合并文件ID';
COMMENT ON COLUMN batch_tasks.summary IS '汇总信息（JSON格式）';
```

### 4.4 历史记录相关表

#### 4.4.1 转换历史表（conversion_history）

```sql
CREATE TABLE conversion_history (
    history_id VARCHAR(64) PRIMARY KEY,
    user_id VARCHAR(64) NOT NULL,
    task_id VARCHAR(64) NOT NULL,
    source_file_id VARCHAR(64) NOT NULL,
    result_file_id VARCHAR(64),
    source_format VARCHAR(50) NOT NULL,
    target_format VARCHAR(50) NOT NULL,
    status task_status_enum NOT NULL,
    conversion_time INTEGER,
    file_size_before BIGINT,
    file_size_after BIGINT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (task_id) REFERENCES conversion_tasks(task_id) ON DELETE CASCADE,
    FOREIGN KEY (source_file_id) REFERENCES files(file_id) ON DELETE CASCADE,
    FOREIGN KEY (result_file_id) REFERENCES files(file_id) ON DELETE SET NULL,
    FOREIGN KEY (source_format) REFERENCES file_formats(format_code) ON DELETE RESTRICT,
    FOREIGN KEY (target_format) REFERENCES file_formats(format_code) ON DELETE RESTRICT
);

COMMENT ON TABLE conversion_history IS '转换历史表';
COMMENT ON COLUMN conversion_history.history_id IS '历史记录ID';
COMMENT ON COLUMN conversion_history.user_id IS '用户ID';
COMMENT ON COLUMN conversion_history.task_id IS '任务ID';
COMMENT ON COLUMN conversion_history.source_file_id IS '源文件ID';
COMMENT ON COLUMN conversion_history.result_file_id IS '结果文件ID';
COMMENT ON COLUMN conversion_history.source_format IS '源格式（引用file_formats字典表）';
COMMENT ON COLUMN conversion_history.target_format IS '目标格式（引用file_formats字典表）';
COMMENT ON COLUMN conversion_history.status IS '转换状态（使用task_status_enum枚举类型）';
COMMENT ON COLUMN conversion_history.conversion_time IS '转换耗时（毫秒）';
COMMENT ON COLUMN conversion_history.file_size_before IS '转换前文件大小';
COMMENT ON COLUMN conversion_history.file_size_after IS '转换后文件大小';
```

### 4.5 系统配置相关表

#### 4.5.1 系统配置表（system_configs）

```sql
CREATE TABLE system_configs (
    config_id VARCHAR(64) PRIMARY KEY,
    config_key VARCHAR(100) NOT NULL UNIQUE,
    config_value TEXT,
    config_type config_type_enum NOT NULL DEFAULT 'string',
    description TEXT,
    is_public BOOLEAN NOT NULL DEFAULT false, -- 是否公开（前端可访问）
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE system_configs IS '系统配置表';
COMMENT ON COLUMN system_configs.config_id IS '配置ID';
COMMENT ON COLUMN system_configs.config_key IS '配置键';
COMMENT ON COLUMN system_configs.config_value IS '配置值';
COMMENT ON COLUMN system_configs.config_type IS '配置类型（使用config_type_enum枚举类型）';
COMMENT ON COLUMN system_configs.description IS '配置说明';
COMMENT ON COLUMN system_configs.is_public IS '是否公开';
```

#### 4.5.2 审计日志表（audit_logs）

```sql
CREATE TABLE audit_logs (
    log_id VARCHAR(64) PRIMARY KEY,
    user_id VARCHAR(64),
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50),
    resource_id VARCHAR(64),
    ip_address VARCHAR(45),
    user_agent TEXT,
    request_id VARCHAR(64),
    details JSONB,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (action) REFERENCES audit_actions(action_code) ON DELETE RESTRICT,
    FOREIGN KEY (resource_type) REFERENCES resource_types(resource_code) ON DELETE SET NULL
);

COMMENT ON TABLE audit_logs IS '审计日志表';
COMMENT ON COLUMN audit_logs.log_id IS '日志ID';
COMMENT ON COLUMN audit_logs.user_id IS '用户ID';
COMMENT ON COLUMN audit_logs.action IS '操作类型（引用audit_actions字典表）';
COMMENT ON COLUMN audit_logs.resource_type IS '资源类型（引用resource_types字典表）';
COMMENT ON COLUMN audit_logs.resource_id IS '资源ID';
COMMENT ON COLUMN audit_logs.ip_address IS 'IP地址';
COMMENT ON COLUMN audit_logs.user_agent IS '用户代理';
COMMENT ON COLUMN audit_logs.request_id IS '请求ID';
COMMENT ON COLUMN audit_logs.details IS '详细信息（JSON格式）';
```

#### 4.5.3 Token黑名单表（token_blacklist）

```sql
CREATE TABLE token_blacklist (
    jti VARCHAR(64) PRIMARY KEY,
    user_id VARCHAR(64),
    token_type token_type_enum NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

COMMENT ON TABLE token_blacklist IS 'Token黑名单表';
COMMENT ON COLUMN token_blacklist.jti IS 'JWT ID';
COMMENT ON COLUMN token_blacklist.user_id IS '用户ID';
COMMENT ON COLUMN token_blacklist.token_type IS 'Token类型（使用token_type_enum枚举类型）';
COMMENT ON COLUMN token_blacklist.expires_at IS '过期时间';
```

---

## 5. 数据库ER图

### 5.1 ER图说明

```text
字典表（独立表）：
  file_formats (独立表)
  audit_actions (独立表)
  resource_types (独立表)

用户相关：
  users (1) ──< (N) user_settings
  users (1) ──< (N) api_keys
  users (1) ──< (N) token_blacklist

文件相关：
  users (1) ──< (N) files
  file_formats (1) ──< (N) files (file_format)

任务相关：
  users (1) ──< (N) conversion_tasks
  users (1) ──< (N) batch_tasks
  files (1) ──< (N) conversion_tasks (source_file_id)
  files (1) ──< (N) conversion_tasks (result_file_id)
  files (1) ──< (N) batch_tasks (merged_file_id)
  batch_tasks (1) ──< (N) conversion_tasks (batch_id)
  file_formats (1) ──< (N) conversion_tasks (target_format)
  file_formats (1) ──< (N) conversion_tasks (source_format)
  file_formats (1) ──< (N) batch_tasks (target_format)

历史记录：
  users (1) ──< (N) conversion_history
  conversion_tasks (1) ──< (N) conversion_history
  files (1) ──< (N) conversion_history (source_file_id)
  files (1) ──< (N) conversion_history (result_file_id)
  file_formats (1) ──< (N) conversion_history (source_format)
  file_formats (1) ──< (N) conversion_history (target_format)

系统配置：
  system_configs (独立表)
  audit_logs (1) ──< (N) users (可选)
  audit_actions (1) ──< (N) audit_logs (action)
  resource_types (1) ──< (N) audit_logs (resource_type)
```

### 5.2 关系说明

**字典表关系：**

- **file_formats ↔ files**：一对多，一个文件格式可以被多个文件使用
- **file_formats ↔ conversion_tasks**：一对多，一个文件格式可以作为多个任务的源格式或目标格式
- **file_formats ↔ batch_tasks**：一对多，一个文件格式可以作为多个批量任务的目标格式
- **file_formats ↔ conversion_history**：一对多，一个文件格式可以出现在多条历史记录中
- **audit_actions ↔ audit_logs**：一对多，一个操作类型可以出现在多条审计日志中
- **resource_types ↔ audit_logs**：一对多，一个资源类型可以出现在多条审计日志中

**业务表关系：**

- **users ↔ user_settings**：一对多，用户可以有多个配置项
- **users ↔ api_keys**：一对多，用户可以创建多个API Key
- **users ↔ files**：一对多，用户可以上传多个文件
- **users ↔ conversion_tasks**：一对多，用户可以创建多个转换任务
- **users ↔ batch_tasks**：一对多，用户可以创建多个批量任务
- **files ↔ conversion_tasks**：一对多，一个文件可以参与多个转换任务（作为源文件或结果文件）
- **batch_tasks ↔ conversion_tasks**：一对多，一个批量任务包含多个转换任务
- **users ↔ conversion_history**：一对多，用户有多个历史记录
- **conversion_tasks ↔ conversion_history**：一对一，每个任务对应一条历史记录

---

## 6. 索引设计

### 6.1 主键索引

所有表的主键自动创建主键索引。

### 6.2 唯一索引

```sql
-- 用户表
CREATE UNIQUE INDEX idx_users_username ON users(username) WHERE deleted_at IS NULL;
CREATE UNIQUE INDEX idx_users_email ON users(email) WHERE deleted_at IS NULL;

-- API密钥表
CREATE UNIQUE INDEX idx_api_keys_hashed_key ON api_keys(hashed_key) WHERE is_active = true;

-- 系统配置表
CREATE UNIQUE INDEX idx_system_configs_key ON system_configs(config_key);

-- 字典表
CREATE UNIQUE INDEX idx_file_formats_code ON file_formats(format_code);
CREATE UNIQUE INDEX idx_audit_actions_code ON audit_actions(action_code);
CREATE UNIQUE INDEX idx_resource_types_code ON resource_types(resource_code);
```

### 6.3 普通索引

```sql
-- 用户表（枚举类型字段可以直接索引）
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_account_type ON users(account_type);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);

-- 文件表
CREATE INDEX idx_files_user_id ON files(user_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_files_format ON files(file_format);
CREATE INDEX idx_files_status ON files(status);
CREATE INDEX idx_files_created_at ON files(created_at);
CREATE INDEX idx_files_auto_delete ON files(auto_delete, delete_after_hours) WHERE auto_delete = true;

-- 转换任务表（枚举类型字段可以直接索引）
CREATE INDEX idx_conversion_tasks_user_id ON conversion_tasks(user_id);
CREATE INDEX idx_conversion_tasks_batch_id ON conversion_tasks(batch_id) WHERE batch_id IS NOT NULL;
CREATE INDEX idx_conversion_tasks_source_file_id ON conversion_tasks(source_file_id);
CREATE INDEX idx_conversion_tasks_status ON conversion_tasks(status);
CREATE INDEX idx_conversion_tasks_task_type ON conversion_tasks(task_type);
CREATE INDEX idx_conversion_tasks_created_at ON conversion_tasks(created_at);
CREATE INDEX idx_conversion_tasks_user_status ON conversion_tasks(user_id, status);

-- 批量任务表（枚举类型字段可以直接索引）
CREATE INDEX idx_batch_tasks_user_id ON batch_tasks(user_id);
CREATE INDEX idx_batch_tasks_status ON batch_tasks(status);
CREATE INDEX idx_batch_tasks_created_at ON batch_tasks(created_at);
CREATE INDEX idx_batch_tasks_user_status ON batch_tasks(user_id, status);

-- 转换历史表（枚举类型字段可以直接索引）
CREATE INDEX idx_conversion_history_user_id ON conversion_history(user_id);
CREATE INDEX idx_conversion_history_task_id ON conversion_history(task_id);
CREATE INDEX idx_conversion_history_status ON conversion_history(status);
CREATE INDEX idx_conversion_history_created_at ON conversion_history(created_at);
CREATE INDEX idx_conversion_history_user_created ON conversion_history(user_id, created_at DESC);

-- 审计日志表
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_resource_type ON audit_logs(resource_type);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
CREATE INDEX idx_audit_logs_user_created ON audit_logs(user_id, created_at DESC);

-- Token黑名单表（枚举类型字段可以直接索引）
CREATE INDEX idx_token_blacklist_expires_at ON token_blacklist(expires_at);
CREATE INDEX idx_token_blacklist_token_type ON token_blacklist(token_type);

-- 字典表索引
CREATE INDEX idx_file_formats_category ON file_formats(format_category);
CREATE INDEX idx_file_formats_supported ON file_formats(is_supported) WHERE is_supported = true;
CREATE INDEX idx_audit_actions_category ON audit_actions(action_category);
CREATE INDEX idx_audit_actions_active ON audit_actions(is_active) WHERE is_active = true;
```

### 6.4 复合索引

```sql
-- 转换任务表：用户+状态+创建时间（用于查询用户的任务列表）
CREATE INDEX idx_conversion_tasks_user_status_created ON conversion_tasks(user_id, status, created_at DESC);

-- 批量任务表：用户+状态+创建时间
CREATE INDEX idx_batch_tasks_user_status_created ON batch_tasks(user_id, status, created_at DESC);

-- 转换历史表：用户+创建时间（用于查询最近30次记录）
CREATE INDEX idx_conversion_history_user_created_limit ON conversion_history(user_id, created_at DESC);

-- 审计日志表：操作类型+创建时间（用于查询特定操作）
CREATE INDEX idx_audit_logs_action_created ON audit_logs(action, created_at DESC);
```

### 6.5 JSONB索引

```sql
-- 文件表：元数据索引（用于查询特定元数据）
CREATE INDEX idx_files_metadata_gin ON files USING GIN(metadata);

-- 转换任务表：选项索引
CREATE INDEX idx_conversion_tasks_options_gin ON conversion_tasks USING GIN(options);

-- 批量任务表：进度索引
CREATE INDEX idx_batch_tasks_progress_gin ON batch_tasks USING GIN(progress);
```

---

## 7. 数据库迁移脚本

### 7.1 初始化脚本

```sql
-- 创建数据库
CREATE DATABASE document_converter
    WITH ENCODING = 'UTF8'
    LC_COLLATE = 'en_US.UTF-8'
    LC_CTYPE = 'en_US.UTF-8'
    TEMPLATE = template0;

-- 连接到数据库
\c document_converter

-- 创建扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm"; -- 用于模糊查询

-- ============================================
-- 第一步：创建枚举类型
-- ============================================
-- 创建所有枚举类型（参见第3.1节）

-- ============================================
-- 第二步：创建字典表
-- ============================================
-- 1. 文件格式字典表（file_formats）
-- 2. 审计操作类型字典表（audit_actions）
-- 3. 资源类型字典表（resource_types）

-- ============================================
-- 第三步：创建业务表（按依赖顺序）
-- ============================================
-- 1. 用户表（users）
-- 2. 用户配置表（user_settings）
-- 3. API密钥表（api_keys）
-- 4. 文件表（files）- 依赖users和file_formats
-- 5. 批量任务表（batch_tasks）- 依赖users和file_formats
-- 6. 转换任务表（conversion_tasks）- 依赖users、files、batch_tasks和file_formats
-- 7. 转换历史表（conversion_history）- 依赖users、conversion_tasks、files和file_formats
-- 8. 系统配置表（system_configs）
-- 9. 审计日志表（audit_logs）- 依赖users、audit_actions和resource_types
-- 10. Token黑名单表（token_blacklist）- 依赖users

-- ============================================
-- 第四步：创建索引
-- ============================================
-- 创建所有索引（参见第6节）

-- ============================================
-- 第五步：创建触发器
-- ============================================
-- 创建触发器（自动更新updated_at）
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_user_settings_updated_at BEFORE UPDATE ON user_settings
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_api_keys_updated_at BEFORE UPDATE ON api_keys
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_files_updated_at BEFORE UPDATE ON files
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_conversion_tasks_updated_at BEFORE UPDATE ON conversion_tasks
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_batch_tasks_updated_at BEFORE UPDATE ON batch_tasks
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_system_configs_updated_at BEFORE UPDATE ON system_configs
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 7.2 初始化数据

```sql
-- ============================================
-- 第一步：初始化字典表数据
-- ============================================
-- 插入文件格式字典表数据（参见第3.3节）
-- 插入审计操作类型字典表数据（参见第3.3节）
-- 插入资源类型字典表数据（参见第3.3节）

-- ============================================
-- 第二步：初始化系统配置
-- ============================================
INSERT INTO system_configs (config_id, config_key, config_value, config_type, description, is_public)
VALUES
    ('config_001', 'max_file_size', '104857600', 'number', '最大文件大小（字节）', true),
    ('config_002', 'max_batch_size', '100', 'number', '最大批量文件数', true),
    ('config_003', 'default_conversion_timeout', '300', 'number', '默认转换超时时间（秒）', false),
    ('config_004', 'supported_formats', '["docx","pdf","xlsx","pptx","md","txt","jpg","png"]', 'json', '支持的文件格式', true),
    ('config_005', 'history_retention_days', '30', 'number', '历史记录保留天数', false);

-- ============================================
-- 第三步：创建默认管理员账户（可选）
-- ============================================
-- 密码需要在实际部署时设置
-- INSERT INTO users (user_id, username, email, password_hash, salt, role, account_type)
-- VALUES ('admin_001', 'admin', 'admin@example.com', 'hashed_password', 'salt', 'admin', 'enterprise');
```

### 7.3 数据清理脚本

```sql
-- 清理过期的Token黑名单记录
DELETE FROM token_blacklist WHERE expires_at < CURRENT_TIMESTAMP;

-- 清理过期的历史记录（保留最近30天）
DELETE FROM conversion_history
WHERE created_at < CURRENT_TIMESTAMP - INTERVAL '30 days';

-- 清理已删除的文件记录（软删除30天后物理删除）
DELETE FROM files
WHERE deleted_at IS NOT NULL
AND deleted_at < CURRENT_TIMESTAMP - INTERVAL '30 days';

-- 清理过期的审计日志（保留最近90天）
DELETE FROM audit_logs
WHERE created_at < CURRENT_TIMESTAMP - INTERVAL '90 days';
```

---

## 8. 性能优化

### 8.1 分区策略

对于大数据量表，考虑使用分区：

```sql
-- 转换历史表按月分区
CREATE TABLE conversion_history_2025_11 PARTITION OF conversion_history
    FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');

-- 审计日志表按月分区
CREATE TABLE audit_logs_2025_11 PARTITION OF audit_logs
    FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');
```

### 8.2 查询优化

- 使用EXPLAIN ANALYZE分析查询计划
- 避免全表扫描
- 合理使用索引
- 使用连接池

### 8.3 数据归档

- 定期归档历史数据
- 使用归档表存储旧数据
- 压缩归档数据

---

## 9. 数据安全

### 9.1 敏感数据加密

- **密码**：使用bcrypt哈希存储
- **API Key**：使用SHA-256哈希存储
- **文件路径**：敏感路径加密存储

### 9.2 数据备份

- **全量备份**：每日全量备份
- **增量备份**：每小时增量备份
- **备份保留**：保留最近30天备份

### 9.3 访问控制

- 使用数据库用户权限控制
- 最小权限原则
- 定期审计数据库访问

## 10. 附录

### 10.1 字段类型说明

- **VARCHAR(n)**：可变长度字符串
- **TEXT**：长文本
- **BIGINT**：大整数（用于文件大小）
- **INTEGER**：整数
- **BOOLEAN**：布尔值
- **TIMESTAMP**：时间戳
- **JSONB**：JSON二进制格式（PostgreSQL特有，支持索引和查询）
- **ENUM类型**：枚举类型，用于固定且不经常变化的枚举值（如用户角色、任务状态等）
- **外键引用**：用于引用字典表，确保数据一致性和可扩展性

### 10.2 枚举类型与字典表的选择原则

**使用枚举类型（ENUM）的场景：**

- 值固定且不会频繁变化
- 值数量较少（通常少于20个）
- 不需要额外的元数据（如描述、分类等）
- 性能要求高，需要数据库级别的约束

**使用字典表的场景：**

- 值可能动态变化或需要扩展
- 需要存储额外的元数据（如描述、分类、是否启用等）
- 需要支持多语言或国际化
- 需要支持软删除或状态管理
- 值数量较多或可能持续增长

**本系统设计：**

- **枚举类型**：用户角色、账户类型、用户状态、存储类型、文件状态、任务类型、任务状态、Token类型、配置类型
- **字典表**：文件格式、审计操作类型、资源类型

### 10.3 参考资源

- [PostgreSQL官方文档](https://www.postgresql.org/docs/)
- [数据库设计最佳实践](https://www.postgresql.org/docs/current/ddl.html)

---

## 更新记录

| 版本号 | 更新日期 | 更新内容 | 更新人 |
| ---- | ---- | ---- | ---- |
| V1.0 | 2025 年 11 月 | 初始版本 | 数据库设计 |
| V1.1 | 2025 年 11 月 | 完善枚举类型和字典表设计，更新所有表结构使用枚举类型或字典表外键 | 数据库设计 |
