# 文档转换工具部署文档

## 版本信息

| 版本号 | 编制日期 | 修订说明 | 编制人 |
| ---- | ----------- | ---- | ----- |
| V1.0 | 2025 年 11 月 | 初始版本 | DevOps |

## 1. 文档说明

### 1.1 文档目的

本文档提供文档转换工具系统的部署指南，包括环境要求、安装步骤、配置说明、运维管理等，帮助运维人员完成系统部署和运维工作。

### 1.2 适用范围

本文档适用于：

- 运维工程师
- 系统管理员
- 部署人员

### 1.3 参考文档

- 《系统概要设计文档（HLD）》
- 《技术选型方案文档》
- 《开发环境搭建指南》

---

## 2. 部署概述

### 2.1 部署模式

文档转换工具支持以下部署模式：

- **个人版**：桌面客户端，单机部署
- **企业版-私有部署**：内网服务器部署
- **企业版-SaaS部署**：云服务器集群部署

### 2.2 部署架构

参考《系统概要设计文档（HLD）》中的部署架构设计。

---

## 3. 环境要求

### 3.1 硬件要求

#### 3.1.1 个人版（桌面客户端）

| 项目 | 最低要求 | 推荐配置 |
| ---- | ---- | ---- |
| CPU | 双核 2.0GHz | 四核 3.0GHz |
| 内存 | 2GB RAM | 8GB RAM |
| 硬盘 | 200MB（程序）+ 1GB（缓存） | 500MB（程序）+ 10GB（缓存） |
| 网络 | 离线可用，在线升级需1Mbps | 10Mbps（云同步功能） |

#### 3.1.2 企业版（服务器）

| 项目 | 最低要求 | 推荐配置 |
| ---- | ---- | ---- |
| CPU | 4核 | 8核+ |
| 内存 | 8GB | 16GB+ |
| 硬盘 | 100GB可用空间 | 500GB+可用空间 |
| 网络 | 100Mbps | 1Gbps |

### 3.2 软件要求

#### 3.2.1 操作系统

**个人版**：

- Windows 10/11、Server 2016+
- macOS 10.15+
- Linux（Ubuntu 20.04+、CentOS 8+）

**企业版**：

- Linux（Ubuntu 20.04+、CentOS 8+、RHEL 8+）
- Windows Server 2016+（可选）

#### 3.2.2 运行时环境

| 软件 | 版本要求 | 说明 |
| ---- | ---- | ---- |
| Node.js | 20 LTS+ | 后端服务必需 |
| Python | 3.10+ | OCR引擎、部分转换工具 |
| PostgreSQL | 14+ | 数据库 |
| Redis | 7.0+ | 缓存和消息队列 |
| Docker | 20.10+ | 容器化部署（推荐） |
| Docker Compose | 2.0+ | 容器编排（推荐） |

#### 3.2.3 转换引擎依赖

| 引擎 | 安装方式 | 说明 |
| ---- | ---- | ---- |
| LibreOffice | 系统包管理器或Docker | Office文档转换 |
| Poppler | 系统包管理器或Docker | PDF处理 |
| PaddleOCR | Python包或Docker | OCR识别（个人版） |

---

## 4. 个人版部署

### 4.1 Windows部署

#### 4.1.1 安装步骤

1. **下载安装包**

   - 访问官网下载页面
   - 下载Windows安装包（.exe或.msi）

2. **运行安装程序**

   ```bash
   # 双击安装包，按照向导完成安装
   ```

3. **首次启动**

   - 启动应用程序
   - 完成初始配置
   - 选择安装路径和缓存目录

#### 4.1.2 配置说明

配置文件位置：`%APPDATA%\DocumentConverter\config.json`

```json
{
  "storage": {
    "path": "C:\\Users\\{username}\\Documents\\DocumentConverter",
    "maxSize": 10737418240
  },
  "conversion": {
    "defaultQuality": "medium",
    "maxConcurrent": 3
  },
  "ocr": {
    "enabled": true,
    "language": ["ch", "en"]
  }
}
```

### 4.2 macOS部署

#### 4.2.1 安装步骤

1. **下载安装包**

   - 访问官网下载页面
   - 下载macOS安装包（.dmg）

2. **安装应用**

   ```bash
   # 打开.dmg文件
   # 将应用拖拽到Applications文件夹
   ```

3. **首次启动**

   - 在Applications中找到应用
   - 右键选择"打开"（首次需要）
   - 完成初始配置

#### 4.2.2 配置说明

配置文件位置：`~/Library/Application Support/DocumentConverter/config.json`

### 4.3 Linux部署

#### 4.3.1 安装步骤

**Ubuntu/Debian**：

```bash
# 下载.deb包
wget https://example.com/document-converter_1.0.0_amd64.deb

# 安装
sudo dpkg -i document-converter_1.0.0_amd64.deb

# 安装依赖（如果有缺失）
sudo apt-get install -f
```

**CentOS/RHEL**：

```bash
# 下载.rpm包
wget https://example.com/document-converter-1.0.0-1.x86_64.rpm

# 安装
sudo rpm -ivh document-converter-1.0.0-1.x86_64.rpm
```

#### 4.3.2 配置说明

配置文件位置：`~/.config/DocumentConverter/config.json`

---

## 5. 企业版私有部署

### 5.1 Docker Compose部署（推荐）

#### 5.1.1 准备工作

1. **安装Docker和Docker Compose**

   ```bash
   # Ubuntu/Debian
   curl -fsSL https://get.docker.com -o get-docker.sh
   sudo sh get-docker.sh
   sudo usermod -aG docker $USER
   
   # 安装Docker Compose
   sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
   sudo chmod +x /usr/local/bin/docker-compose
   ```

2. **创建部署目录**

   ```bash
   mkdir -p /opt/document-converter
   cd /opt/document-converter
   ```

#### 5.1.2 配置文件

创建`docker-compose.yml`：

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:14-alpine
    container_name: doc-converter-db
    environment:
      POSTGRES_USER: ${DB_USER:-docconverter}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
      POSTGRES_DB: ${DB_NAME:-document_converter}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-docconverter}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: doc-converter-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-changeme}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    image: document-converter/backend:latest
    container_name: doc-converter-backend
    environment:
      DATABASE_URL: postgresql://${DB_USER:-docconverter}:${DB_PASSWORD:-changeme}@postgres:5432/${DB_NAME:-document_converter}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme}
      JWT_SECRET: ${JWT_SECRET:-changeme}
      API_PORT: 3000
    volumes:
      - ./storage:/app/storage
      - ./logs:/app/logs
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  web:
    image: document-converter/web:latest
    container_name: doc-converter-web
    environment:
      VITE_API_BASE_URL: ${API_BASE_URL:-http://localhost:3000/api/v1}
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
```

创建`.env`文件：

```env
# 数据库配置
DB_USER=docconverter
DB_PASSWORD=your-secure-password
DB_NAME=document_converter

# Redis配置
REDIS_PASSWORD=your-secure-password

# JWT配置
JWT_SECRET=your-jwt-secret-key

# API配置
API_BASE_URL=http://your-domain.com/api/v1
```

#### 5.1.3 部署步骤

```bash
# 1. 拉取镜像（或构建镜像）
docker-compose pull

# 2. 启动服务
docker-compose up -d

# 3. 初始化数据库
docker-compose exec backend pnpm prisma migrate deploy

# 4. 检查服务状态
docker-compose ps

# 5. 查看日志
docker-compose logs -f
```

### 5.2 手动部署

#### 5.2.1 安装依赖

```bash
# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装PostgreSQL
sudo apt-get install -y postgresql-14

# 安装Redis
sudo apt-get install -y redis-server

# 安装LibreOffice
sudo apt-get install -y libreoffice

# 安装Poppler
sudo apt-get install -y poppler-utils
```

#### 5.2.2 配置数据库

```bash
# 创建数据库用户
sudo -u postgres createuser -P docconverter

# 创建数据库
sudo -u postgres createdb -O docconverter document_converter

# 运行迁移
cd /opt/document-converter/backend
pnpm prisma migrate deploy
```

#### 5.2.3 配置服务

创建systemd服务文件`/etc/systemd/system/doc-converter-backend.service`：

```ini
[Unit]
Description=Document Converter Backend
After=network.target postgresql.service redis.service

[Service]
Type=simple
User=docconverter
WorkingDirectory=/opt/document-converter/backend
Environment=NODE_ENV=production
ExecStart=/usr/bin/node dist/index.js
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable doc-converter-backend
sudo systemctl start doc-converter-backend
```

---

## 6. 企业版SaaS部署

### 6.1 云服务器部署

#### 6.1.1 服务器配置

推荐使用云服务器（阿里云、AWS、Azure等）：

- **计算**：8核16GB以上
- **存储**：SSD 500GB+
- **网络**：1Gbps
- **负载均衡**：配置负载均衡器

#### 6.1.2 容器编排（Kubernetes）

创建Kubernetes部署文件（示例）：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: doc-converter-backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: doc-converter-backend
  template:
    metadata:
      labels:
        app: doc-converter-backend
    spec:
      containers:
      - name: backend
        image: document-converter/backend:latest
        ports:
        - containerPort: 3000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: doc-converter-secrets
              key: database-url
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
```

### 6.2 对象存储配置

#### 6.2.1 阿里云OSS

```typescript
// 配置OSS
const ossConfig = {
  region: 'oss-cn-hangzhou',
  accessKeyId: process.env.OSS_ACCESS_KEY_ID,
  accessKeySecret: process.env.OSS_ACCESS_KEY_SECRET,
  bucket: 'document-converter',
}
```

#### 6.2.2 AWS S3

```typescript
// 配置S3
const s3Config = {
  region: 'us-east-1',
  accessKeyId: process.env.AWS_ACCESS_KEY_ID,
  secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
  bucket: 'document-converter',
}
```

---

## 7. 配置说明

### 7.1 环境变量

#### 7.1.1 后端配置

| 变量名 | 说明 | 默认值 | 必需 |
| ---- | ---- | ---- | ---- |
| DATABASE_URL | 数据库连接字符串 | - | 是 |
| REDIS_HOST | Redis主机 | localhost | 是 |
| REDIS_PORT | Redis端口 | 6379 | 否 |
| REDIS_PASSWORD | Redis密码 | - | 否 |
| JWT_SECRET | JWT密钥 | - | 是 |
| API_PORT | API端口 | 3000 | 否 |
| FILE_STORAGE_PATH | 文件存储路径 | ./storage | 否 |
| FILE_MAX_SIZE | 文件最大大小（字节） | 104857600 | 否 |

#### 7.1.2 前端配置

| 变量名 | 说明 | 默认值 | 必需 |
| ---- | ---- | ---- | ---- |
| VITE_API_BASE_URL | API基础URL | `http://localhost:3000/api/v1` | 是 |
| VITE_APP_TITLE | 应用标题 | 文档转换工具 | 否 |

### 7.2 数据库配置

#### 7.2.1 PostgreSQL配置

```sql
-- 创建数据库
CREATE DATABASE document_converter;

-- 创建用户
CREATE USER docconverter WITH PASSWORD 'your-password';

-- 授权
GRANT ALL PRIVILEGES ON DATABASE document_converter TO docconverter;
```

#### 7.2.2 Redis配置

```conf
# redis.conf
bind 0.0.0.0
port 6379
requirepass your-password
maxmemory 2gb
maxmemory-policy allkeys-lru
```

---

## 8. 运维管理

### 8.1 服务管理

#### 8.1.1 Docker Compose

```bash
# 启动服务
docker-compose up -d

# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 查看日志
docker-compose logs -f backend

# 查看状态
docker-compose ps
```

#### 8.1.2 Systemd

```bash
# 启动服务
sudo systemctl start doc-converter-backend

# 停止服务
sudo systemctl stop doc-converter-backend

# 重启服务
sudo systemctl restart doc-converter-backend

# 查看状态
sudo systemctl status doc-converter-backend

# 查看日志
sudo journalctl -u doc-converter-backend -f
```

### 8.2 监控和日志

#### 8.2.1 健康检查

```bash
# 检查API健康状态
curl http://localhost:3000/api/v1/system/status

# 检查数据库连接
docker-compose exec postgres pg_isready

# 检查Redis连接
docker-compose exec redis redis-cli ping
```

#### 8.2.2 日志管理

```bash
# 查看应用日志
docker-compose logs -f backend

# 查看错误日志
docker-compose logs backend | grep ERROR

# 日志轮转配置（logrotate）
/opt/document-converter/logs/*.log {
    daily
    rotate 7
    compress
    missingok
    notifempty
}
```

### 8.3 备份和恢复

#### 8.3.1 数据库备份

```bash
# 备份数据库
docker-compose exec postgres pg_dump -U docconverter document_converter > backup_$(date +%Y%m%d).sql

# 恢复数据库
docker-compose exec -T postgres psql -U docconverter document_converter < backup_20251115.sql
```

#### 8.3.2 文件备份

```bash
# 备份存储文件
tar -czf storage_backup_$(date +%Y%m%d).tar.gz /opt/document-converter/storage

# 恢复文件
tar -xzf storage_backup_20251115.tar.gz -C /
```

---

## 9. 故障排查

### 9.1 常见问题

#### 9.1.1 服务无法启动

**问题**：后端服务无法启动

**排查步骤**：

1. 检查日志：`docker-compose logs backend`
2. 检查数据库连接：`docker-compose exec postgres pg_isready`
3. 检查Redis连接：`docker-compose exec redis redis-cli ping`
4. 检查端口占用：`netstat -tulpn | grep 3000`
5. 检查环境变量：`docker-compose config`

#### 9.1.2 数据库连接失败

**问题**：无法连接到PostgreSQL

**排查步骤**：

1. 检查数据库服务状态
2. 检查连接字符串格式
3. 检查防火墙设置
4. 检查用户权限

#### 9.1.3 文件转换失败

**问题**：文件转换失败

**排查步骤**：

1. 检查转换引擎是否安装（LibreOffice、Poppler）
2. 检查文件权限
3. 检查磁盘空间
4. 查看转换日志

### 9.2 性能优化

#### 9.2.1 数据库优化

```sql
-- 创建索引
CREATE INDEX idx_tasks_user_id ON conversion_tasks(user_id);
CREATE INDEX idx_tasks_status ON conversion_tasks(status);
CREATE INDEX idx_tasks_created_at ON conversion_tasks(created_at);
```

#### 9.2.2 Redis优化

```conf
# 优化内存使用
maxmemory 4gb
maxmemory-policy allkeys-lru

# 启用持久化
save 900 1
save 300 10
save 60 10000
```

---

## 10. 安全配置

### 10.1 网络安全

- **HTTPS**：配置SSL证书，强制HTTPS访问
- **防火墙**：只开放必要端口（80、443、3000）
- **VPN**：内网访问使用VPN

### 10.2 数据安全

- **数据加密**：敏感数据加密存储
- **传输加密**：使用HTTPS传输
- **备份加密**：备份文件加密存储

### 10.3 访问控制

- **认证授权**：启用JWT和API Key认证
- **权限控制**：基于角色的访问控制
- **审计日志**：记录所有操作日志

---

## 11. 升级和维护

### 11.1 版本升级

#### 11.1.1 Docker Compose升级

```bash
# 1. 备份数据
docker-compose exec postgres pg_dump -U docconverter document_converter > backup.sql

# 2. 拉取新镜像
docker-compose pull

# 3. 停止服务
docker-compose down

# 4. 启动新版本
docker-compose up -d

# 5. 运行数据库迁移
docker-compose exec backend pnpm prisma migrate deploy
```

### 11.2 定期维护

- **日志清理**：定期清理旧日志
- **数据备份**：每日备份数据库和文件
- **安全更新**：定期更新系统和依赖
- **性能监控**：监控系统性能和资源使用

---

## 12. 附录

### 12.1 参考资源

- [Docker官方文档](https://docs.docker.com/)
- [PostgreSQL官方文档](https://www.postgresql.org/docs/)
- [Redis官方文档](https://redis.io/documentation)

### 12.2 联系方式

如有问题，请联系：

- **技术支持**：<support@example.com>
- **运维支持**：<ops@example.com>

---

## 更新记录

| 版本号 | 更新日期 | 更新内容 | 更新人 |
| ---- | ---- | ---- | ---- |
| V1.0 | 2025 年 11 月 | 初始版本 | DevOps |
