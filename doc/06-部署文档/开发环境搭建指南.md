# 开发环境搭建指南

## 版本信息

| 版本号 | 编制日期 | 修订说明 | 编制人 |
| ---- | ----------- | ---- | ----- |
| V1.0 | 2025 年 11 月 | 初始版本 | DevOps |

## 1. 文档说明

### 1.1 文档目的

本文档详细说明文档转换工具项目的开发环境搭建步骤，包括代码仓库配置、开发工具安装、CI/CD配置、测试环境搭建等，帮助开发人员快速搭建开发环境。

### 1.2 适用范围

本文档适用于：

- 新加入项目的开发人员
- DevOps工程师
- 测试工程师

### 1.3 参考文档

- 《技术选型方案文档》
- 《开发规范文档》

---

## 2. 环境要求

### 2.1 硬件要求

| 项目 | 最低要求 | 推荐配置 |
| ---- | ---- | ---- |
| CPU | 4核 | 8核 |
| 内存 | 8GB | 16GB |
| 磁盘 | 50GB可用空间 | 100GB可用空间 |

### 2.2 软件要求

| 软件 | 版本要求 | 说明 |
| ---- | ---- | ---- |
| Node.js | 20 LTS+ | 后端开发必需 |
| Python | 3.10+ | OCR引擎、部分转换工具 |
| Git | 2.30+ | 版本控制 |
| Docker | 20.10+ | 容器化部署（可选） |
| PostgreSQL | 14+ | 数据库 |
| Redis | 7.0+ | 缓存和消息队列 |

### 2.3 开发工具

| 工具 | 说明 | 必需性 |
| ---- | ---- | ---- |
| VS Code | 推荐IDE | 推荐 |
| Chrome/Edge | 浏览器调试 | 必需 |
| Postman | API测试 | 推荐 |
| DBeaver | 数据库管理 | 推荐 |

---

## 3. 代码仓库搭建

### 3.1 仓库结构

```text
文档转换工具/
├── desktop/              # 桌面客户端（Electron）
│   ├── src/
│   ├── public/
│   └── package.json
├── web/                  # Web前端
│   ├── src/
│   ├── public/
│   └── package.json
├── backend/              # 后端服务
│   ├── src/
│   ├── prisma/
│   └── package.json
├── shared/               # 共享代码
│   └── types/
├── docs/                 # 文档
├── scripts/             # 脚本
├── docker/              # Docker配置
├── .github/             # GitHub Actions配置
├── .gitignore
└── README.md
```

### 3.2 Git配置

#### 3.2.1 初始化仓库

```bash
# 创建主仓库
git init
git remote add origin https://github.com/your-org/document-converter.git

# 创建主分支
git checkout -b main
git push -u origin main

# 创建开发分支
git checkout -b develop
git push -u origin develop
```

#### 3.2.2 分支策略

- **main**：生产环境分支，仅通过PR合并
- **develop**：开发环境分支，日常开发合并到此分支
- **feature/***：功能分支，从develop创建
- **fix/***：修复分支，从develop创建
- **release/***：发布分支，从develop创建
- **hotfix/***：热修复分支，从main创建

#### 3.2.3 .gitignore配置

```gitignore
# 依赖
node_modules/
.pnp
.pnp.js

# 构建输出
dist/
build/
*.tsbuildinfo

# 环境变量
.env
.env.local
.env.*.local

# 日志
logs/
*.log
npm-debug.log*

# 测试
coverage/
.nyc_output/

# IDE
.vscode/
.idea/
*.swp
*.swo

# 系统文件
.DS_Store
Thumbs.db

# 临时文件
tmp/
temp/
*.tmp

# 数据库
*.db
*.sqlite

# 密钥
*.pem
*.key
*.cert
```

### 3.3 代码审查配置

#### 3.3.1 GitHub/GitLab设置

- **分支保护规则**：main和develop分支需要PR审查
- **审查要求**：至少1人审查通过
- **状态检查**：CI/CD通过后才能合并

---

## 4. 开发工具配置

### 4.1 Node.js环境

#### 4.1.1 安装Node.js

```bash
# 使用nvm安装（推荐）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 20
nvm use 20

# 或直接下载安装
# https://nodejs.org/
```

#### 4.1.2 配置npm

```bash
# 设置npm镜像（可选，国内使用）
npm config set registry https://registry.npmmirror.com

# 安装pnpm（推荐包管理器）
npm install -g pnpm
```

### 4.2 IDE配置

#### 4.2.1 VS Code扩展

推荐安装以下扩展：

- **ESLint**：代码检查
- **Prettier**：代码格式化
- **TypeScript**：TypeScript支持
- **GitLens**：Git增强
- **Docker**：Docker支持
- **REST Client**：API测试

#### 4.2.2 VS Code设置

创建`.vscode/settings.json`：

```json
{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "typescript.tsdk": "node_modules/typescript/lib",
  "files.eol": "\n",
  "files.insertFinalNewline": true,
  "files.trimTrailingWhitespace": true
}
```

### 4.3 代码质量工具

#### 4.3.1 ESLint配置

创建`.eslintrc.json`：

```json
{
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "prettier"
  ],
  "parser": "@typescript-eslint/parser",
  "plugins": ["@typescript-eslint"],
  "rules": {
    "@typescript-eslint/no-explicit-any": "warn",
    "@typescript-eslint/explicit-function-return-type": "off",
    "no-console": ["warn", { "allow": ["warn", "error"] }]
  }
}
```

#### 4.3.2 Prettier配置

创建`.prettierrc.json`：

```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2,
  "useTabs": false
}
```

#### 4.3.3 Husky配置

```bash
# 安装Husky
pnpm add -D husky lint-staged

# 初始化Husky
npx husky install

# 添加pre-commit钩子
npx husky add .husky/pre-commit "npx lint-staged"
```

创建`.lintstagedrc.json`：

```json
{
  "*.{ts,tsx}": ["eslint --fix", "prettier --write"],
  "*.{json,md}": ["prettier --write"]
}
```

---

## 5. 项目初始化

### 5.1 克隆仓库

```bash
# 克隆仓库
git clone https://github.com/your-org/document-converter.git
cd document-converter

# 切换到开发分支
git checkout develop
```

### 5.2 安装依赖

```bash
# 安装根目录依赖
pnpm install

# 安装各子项目依赖
cd desktop && pnpm install
cd ../web && pnpm install
cd ../backend && pnpm install
```

### 5.3 环境变量配置

#### 5.3.1 后端环境变量

创建`backend/.env`：

```env
# 数据库
DATABASE_URL="postgresql://user:password@localhost:5432/document_converter?schema=public"

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d
REFRESH_TOKEN_SECRET=your-refresh-secret
REFRESH_TOKEN_EXPIRES_IN=30d

# API
API_PORT=3000
API_HOST=localhost

# 文件存储
FILE_STORAGE_PATH=./storage
FILE_MAX_SIZE=104857600

# AI服务
BAIDU_API_KEY=your-api-key
BAIDU_SECRET_KEY=your-secret-key

# OCR服务
PADDLE_OCR_MODEL_PATH=./models/paddleocr
```

#### 5.3.2 前端环境变量

创建`web/.env`：

```env
VITE_API_BASE_URL=http://localhost:3000/api/v1
VITE_APP_TITLE=文档转换工具
```

### 5.4 数据库初始化

```bash
cd backend

# 运行数据库迁移
pnpm prisma migrate dev

# 生成Prisma客户端
pnpm prisma generate

# 初始化种子数据（可选）
pnpm prisma db seed
```

---

## 6. CI/CD配置

### 6.1 GitHub Actions配置

创建`.github/workflows/ci.yml`：

```yaml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'pnpm'
      - run: pnpm install
      - run: pnpm lint

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'pnpm'
      - run: pnpm install
      - run: pnpm test

  build:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'pnpm'
      - run: pnpm install
      - run: pnpm build
```

### 6.2 Docker配置

#### 6.2.1 后端Dockerfile

创建`backend/Dockerfile`：

```dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

COPY package.json pnpm-lock.yaml ./
RUN npm install -g pnpm && pnpm install

COPY . .
RUN pnpm build

FROM node:20-alpine

WORKDIR /app

COPY package.json pnpm-lock.yaml ./
RUN npm install -g pnpm && pnpm install --prod

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/prisma ./prisma

EXPOSE 3000

CMD ["node", "dist/index.js"]
```

#### 6.2.2 Docker Compose配置

创建`docker-compose.yml`：

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:14-alpine
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: document_converter
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  backend:
    build: ./backend
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: postgresql://user:password@postgres:5432/document_converter
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      - postgres
      - redis
    volumes:
      - ./backend/storage:/app/storage

volumes:
  postgres_data:
  redis_data:
```

---

## 7. 测试环境搭建

### 7.1 测试数据库

```bash
# 创建测试数据库
createdb document_converter_test

# 运行测试迁移
cd backend
DATABASE_URL="postgresql://user:password@localhost:5432/document_converter_test" pnpm prisma migrate deploy
```

### 7.2 测试配置

创建`backend/jest.config.js`：

```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/src'],
  testMatch: ['**/__tests__/**/*.test.ts'],
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
    '!src/**/__tests__/**',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
};
```

### 7.3 运行测试

```bash
# 运行所有测试
pnpm test

# 运行测试并生成覆盖率报告
pnpm test:coverage

# 运行特定测试文件
pnpm test src/services/file.service.test.ts
```

---

## 8. 本地开发

### 8.1 启动服务

#### 8.1.1 启动数据库和Redis

```bash
# 使用Docker Compose
docker-compose up -d postgres redis

# 或手动启动
# PostgreSQL和Redis需要单独安装和启动
```

#### 8.1.2 启动后端

```bash
cd backend

# 开发模式
pnpm dev

# 或使用ts-node-dev
pnpm dev:watch
```

#### 8.1.3 启动前端

```bash
cd web

# 开发模式
pnpm dev
```

#### 8.1.4 启动桌面客户端

```bash
cd desktop

# 开发模式
pnpm dev
```

### 8.2 开发流程

1. **创建功能分支**：`git checkout -b feature/your-feature`
2. **开发功能**：编写代码，遵循开发规范
3. **运行测试**：`pnpm test`
4. **提交代码**：遵循提交规范
5. **创建PR**：提交Pull Request
6. **代码审查**：等待审查通过
7. **合并代码**：审查通过后合并到develop

---

## 9. 常见问题

### 9.1 依赖安装失败

**问题**：pnpm install失败

**解决方案**：

```bash
# 清除缓存
pnpm store prune

# 删除node_modules和锁文件
rm -rf node_modules pnpm-lock.yaml

# 重新安装
pnpm install
```

### 9.2 数据库连接失败

**问题**：无法连接到PostgreSQL

**解决方案**：

1. 检查PostgreSQL是否运行：`pg_isready`
2. 检查连接字符串是否正确
3. 检查防火墙设置
4. 检查数据库用户权限

### 9.3 端口被占用

**问题**：端口3000已被占用

**解决方案**：

```bash
# 查找占用端口的进程
lsof -i :3000

# 或使用netstat
netstat -ano | findstr :3000

# 杀死进程或修改端口配置
```

---

## 10. 附录

### 10.1 参考资源

- [Node.js官方文档](https://nodejs.org/)
- [TypeScript官方文档](https://www.typescriptlang.org/)
- [Git官方文档](https://git-scm.com/)
- [Docker官方文档](https://docs.docker.com/)

### 10.2 联系方式

如有问题，请联系：

- **技术负责人**：<tech-lead@example.com>
- **DevOps**：<devops@example.com>

---

## 更新记录

| 版本号 | 更新日期 | 更新内容 | 更新人 |
| ---- | ---- | ---- | ---- |
| V1.0 | 2025 年 11 月 | 初始版本 | DevOps |
